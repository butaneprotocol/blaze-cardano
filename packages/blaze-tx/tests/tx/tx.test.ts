import {
  Address,
  AuxiliaryData,
  Datum,
  DatumHash,
  hardCodedProtocolParams,
  HexBlob,
  NetworkId,
  Slot,
  RewardAccount,
  PlutusData,
  PlutusV2Script,
  Script,
  TransactionId,
  TransactionInput,
  TransactionOutput,
  TransactionUnspentOutput,
  Value,
  PlutusV1Script,
  Metadatum,
  Metadata,
  Ed25519KeyHashHex,
} from "@blaze-cardano/core";
import { makeUplcEvaluator } from "@blaze-cardano/vm";
import * as value from "../../src/value";
import { TxBuilder } from "../../src/TxBuilder";

function flatten<U>(iterator: IterableIterator<U> | undefined): U[] {
  if (!iterator) {
    return [];
  }
  const result: U[] = [];
  for (const item of iterator) {
    result.push(item);
  }
  return result;
}

const ASSETS = Array.from({ length: 1200 }, (_, i) =>
  i
    .toString(16)
    .padStart(2, "0")
    .concat("ef".repeat(56 / 2)),
);

describe("Transaction Building", () => {
  it("A complex transaction should balance correctly", async () => {
    const ASSET_NAME_1 = ASSETS[0]!;
    const ASSET_NAME_2 = ASSETS[1]!;
    // $hosky
    const testAddress = Address.fromBech32(
      "addr1q86ylp637q7hv7a9r387nz8d9zdhem2v06pjyg75fvcmen3rg8t4q3f80r56p93xqzhcup0w7e5heq7lnayjzqau3dfs7yrls5",
    );
    const utxos = [
      new TransactionUnspentOutput(
        new TransactionInput(TransactionId("0".repeat(64)), 0n),
        new TransactionOutput(
          testAddress,
          value.makeValue(50_000_000n, [ASSET_NAME_1, 1n], [ASSET_NAME_2, 1n]),
        ),
      ),
      new TransactionUnspentOutput(
        new TransactionInput(TransactionId("1".padStart(64, "0")), 0n),
        new TransactionOutput(
          testAddress,
          value.makeValue(40_000_000n, [ASSET_NAME_1, 1n], [ASSET_NAME_2, 1n]),
        ),
      ),
    ];
    const tx = await new TxBuilder(hardCodedProtocolParams)
      .addUnspentOutputs(utxos)
      .setNetworkId(NetworkId.Testnet)
      .setChangeAddress(testAddress)
      .payAssets(testAddress, value.makeValue(48_708_900n, [ASSET_NAME_1, 1n]))
      .complete();

    const inputValue =
      // value.merge(
      tx
        .body()
        .inputs()
        .values()
        .map((x) =>
          utxos
            .find((y) => y.input().toCbor() == x.toCbor())!
            .output()
            .amount(),
        )
        .reduce(value.merge, value.zero());
    //   ,new Value(
    //     flatten(tx.body().withdrawals()?.values()).reduce((x, y) => x + y, 0n),
    //   ),
    // )

    const outputValue = value.merge(
      flatten(tx.body().outputs().values())
        .map((x) => x.amount())
        .reduce(value.merge, value.zero()),
      new Value(tx.body().fee()),
    );

    // console.log("Change: ", tx.body().outputs().at(1)?.amount().coin());

    // console.dir(inputValue.toCore(), { depth: null });
    // console.dir(outputValue.toCore(), { depth: null });

    // console.dir(tx.toCore(), {depth: null})
    expect(inputValue.toCbor()).toEqual(outputValue.toCbor());
  });

  it("Should correctly balance change for a really big output change", async () => {
    // $hosky
    const testAddress = Address.fromBech32(
      "addr1q86ylp637q7hv7a9r387nz8d9zdhem2v06pjyg75fvcmen3rg8t4q3f80r56p93xqzhcup0w7e5heq7lnayjzqau3dfs7yrls5",
    );
    const utxo1Assets: [string, bigint][] = ASSETS.slice(
      0,
      ASSETS.length / 2,
    ).map((x) => [x, 1n]);
    const utxo2Assets: [string, bigint][] = ASSETS.slice(ASSETS.length / 2).map(
      (x) => [x, 1n],
    );
    const utxos = [
      new TransactionUnspentOutput(
        new TransactionInput(TransactionId("0".repeat(64)), 0n),
        new TransactionOutput(
          testAddress,
          value.makeValue(10_000_000_000n, ...utxo1Assets),
        ),
      ),
      new TransactionUnspentOutput(
        new TransactionInput(TransactionId("1".padStart(64, "0")), 0n),
        new TransactionOutput(
          testAddress,
          value.makeValue(10_000_000_000n, ...utxo2Assets),
        ),
      ),
    ];
    const tx = await new TxBuilder(hardCodedProtocolParams)
      .addUnspentOutputs(utxos)
      .setNetworkId(NetworkId.Testnet)
      .setChangeAddress(testAddress)
      .payAssets(
        testAddress,
        value.makeValue(10_001_000_000n, [ASSETS[0]!, 1n]),
      )
      .complete();

    const inputValue =
      // value.merge(
      tx
        .body()
        .inputs()
        .values()
        .map((x) =>
          utxos
            .find((y) => {
              return y.input().toCbor() == x.toCbor();
            })!
            .output()
            .amount(),
        )
        .reduce(value.merge, value.zero());
    //   ,new Value(
    //     flatten(tx.body().withdrawals()?.values()).reduce((x, y) => x + y, 0n),
    //   ),
    // )
    //

    const outputValue = value.merge(
      Array.from(tx.body().outputs().values())
        .map((x) => x.amount())
        .reduce(value.merge, value.zero()),
      new Value(tx.body().fee()),
    );

    expect(tx.body().fee().toString()).toEqual("1992425");

    // console.log("Change: ", tx.body().outputs().at(1)?.amount().coin());

    // console.dir(inputValue.toCore(), { depth: null });
    // console.dir(outputValue.toCore(), { depth: null });

    expect(inputValue.multiasset()?.size).toEqual(
      outputValue.multiasset()?.size,
    );
    expect(inputValue.toCbor()).toEqual(outputValue.toCbor());
  });

  it("A transaction should always have some inputs", async () => {
    // $hosky
    const testAddress = Address.fromBech32(
      "addr1q86ylp637q7hv7a9r387nz8d9zdhem2v06pjyg75fvcmen3rg8t4q3f80r56p93xqzhcup0w7e5heq7lnayjzqau3dfs7yrls5",
    );
    const utxos = [
      new TransactionUnspentOutput(
        new TransactionInput(TransactionId("0".repeat(64)), 0n),
        new TransactionOutput(testAddress, value.makeValue(50_000_000n)),
      ),
      new TransactionUnspentOutput(
        new TransactionInput(TransactionId("1".padStart(64, "0")), 0n),
        new TransactionOutput(testAddress, value.makeValue(40_000_000n)),
      ),
    ];
    const tx = await new TxBuilder(hardCodedProtocolParams)
      .addUnspentOutputs(utxos)
      .setNetworkId(NetworkId.Testnet)
      .setChangeAddress(testAddress)
      .addWithdrawal(
        RewardAccount.fromCredential(
          testAddress.getProps().paymentPart!,
          NetworkId.Testnet,
        ),
        100_000_000n,
      )
      .payAssets(testAddress, value.makeValue(48_708_900n))
      .complete();

    const inputValue = value.merge(
      tx
        .body()
        .inputs()
        .values()
        .map((x) =>
          utxos
            .find((y) => y.input().toCbor() == x.toCbor())!
            .output()
            .amount(),
        )
        .reduce(value.merge, value.zero()),
      value.makeValue(100_000_000n),
    );

    const outputValue = value.merge(
      flatten(tx.body().outputs().values())
        .map((x) => x.amount())
        .reduce(value.merge, value.zero()),
      new Value(tx.body().fee()),
    );
    expect(inputValue.toCbor()).toEqual(outputValue.toCbor());
    expect(tx.body().inputs().values().length).toBeGreaterThan(0);
  });
  // The following test is based on the below transaction, which was a transaction built by JPG Store. It created a fee that was too small.
  // 84a90082825820db1c583fc6117b2370e4d11016a39b3e1f8352455b15bd07c6bf057e0a8e2dde008258203a6e908226c3e85d05c9ab76d38786ed7ba84cd920dd320baea85964e17d921c040185a30058393184cc25ea4c29951d40b443b95bbc5676bc425470f96376d1984af9ab2c967f4bd28944b06462e13c5e3f5d5fa6e03f8567569438cd833e6d011a00b6cce0028201d8185822582067f5229ae335a0f6331ee86b3b4a31c0c9bcdb41a591663acec78a0ab62be174825839011d1c186d5bc22eb56035c37e370f0dcc2c300e8e5f0fa46a6bfdda99a03de54eefd4acaf0e40dd1ca949fbcd2f6658f9703c8f59ca968a761a01c90030825839016a4ee8e9e3913b2952b6f69f667fdc47184f55dcb4f8c678cf59b9de591f2f3dae1f4c91c4edce5b26a93ac25b3f813e245ac19db95d90891a213436b0825839014e1cbebe49ccbb538fb58b29ba439cdb6c9ade5b10d1f201008e1f4d2f4f939101e76ba35586e8c3fd93a0334f74a11f36cf3a7df5411bb0821a0012050ca1581c40fa2aa67258b4ce7b5782f74831d46a84c59a0ff0c28262fab21728a14e436c61794e6174696f6e3337303101825839014e1cbebe49ccbb538fb58b29ba439cdb6c9ade5b10d1f201008e1f4d2f4f939101e76ba35586e8c3fd93a0334f74a11f36cf3a7df5411bb01a5293f64d021a00047313031a085de11e0b5820811d43a658e8157a12063822a0ce3e3eac4e26686aa19519c88e87ed4dfb46cb0d8182582069b685a7de3799cf778714ed2dee97dab7a983106caf75c9f752afc20399a29c0510825839014e1cbebe49ccbb538fb58b29ba439cdb6c9ade5b10d1f201008e1f4d2f4f939101e76ba35586e8c3fd93a0334f74a11f36cf3a7df5411bb01a00459ea3111a0006ac9d12818258201693c508b6132e89b932754d657d28b24068ff5ff1715fec36c010d4d6470b3d00a20481d8799f9fd8799fd8799fd8799f581c1d1c186d5bc22eb56035c37e370f0dcc2c300e8e5f0fa46a6bfdda99ffd8799fd8799fd8799f581ca03de54eefd4acaf0e40dd1ca949fbcd2f6658f9703c8f59ca968a76ffffffff1a01c90030ffd8799fd8799fd8799f581c6a4ee8e9e3913b2952b6f69f667fdc47184f55dcb4f8c678cf59b9deffd8799fd8799fd8799f581c591f2f3dae1f4c91c4edce5b26a93ac25b3f813e245ac19db95d9089ffffffff1a213436b0ffff581c6a4ee8e9e3913b2952b6f69f667fdc47184f55dcb4f8c678cf59b9deff0581840001d8799f00ff821a000326a91a04555e60f5f6
  it("Should calculate fee correctly running script", async () => {
    const outputAddress = Address.fromBech32(
      "addr1q98pe047f8xtk5u0kk9jnwjrnndkexk7tvgdruspqz8p7nf0f7fezq08dw34tphgc07e8gpnfa62z8ekeua8ma2prwcqzy3jhn",
    );
    const jpgAddress = Address.fromBech32(
      "addr1x8rjw3pawl0kelu4mj3c8x20fsczf5pl744s9mxz9v8n7efvjel5h55fgjcxgchp830r7h2l5msrlpt8262r3nvr8ekstg4qrx",
    );
    const inputAddress = Address.fromBech32(
      "addr1q98pe047f8xtk5u0kk9jnwjrnndkexk7tvgdruspqz8p7nf0f7fezq08dw34tphgc07e8gpnfa62z8ekeua8ma2prwcqzy3jhn",
    );

    const utxos = [
      new TransactionUnspentOutput(
        new TransactionInput(
          TransactionId(
            "3a6e908226c3e85d05c9ab76d38786ed7ba84cd920dd320baea85964e17d921c",
          ),
          4n,
        ),

        new TransactionOutput(inputAddress, value.makeValue(1_984_573_620n)),
      ),
    ];

    const refOutput = new TransactionOutput(
      Address.fromBech32(
        "addr1w8rjw3pawl0kelu4mj3c8x20fsczf5pl744s9mxz9v8n7eg0fcr8k",
      ),
      value.makeValue(8124350n),
    );

    const jpgAskScript = Script.newPlutusV2Script(
      PlutusV2Script.fromCbor(
        HexBlob(
          "59068959068601000032323232323232323232322223232533300a323232323232323232323232323232323232533301c3370e900000089919191919191919191919192999814002099b8848000ccc0040140180204c8c8c8c8c8c8c8c8c8c8c8c8c94ccc0e0c0ec0184c8c8c94ccc0ecc0f80084c8c8c8c94ccc0f14ccc0f14ccc0f0028402452808008a50100214a066e24040008cdc7802a44100375a60760046eb8c0e400458c0f0004dd5981c0011bae30360011630390053375e00c98150d8799fd87a9f581c84cc25ea4c29951d40b443b95bbc5676bc425470f96376d1984af9abffd8799fd8799fd87a9f581c2c967f4bd28944b06462e13c5e3f5d5fa6e03f8567569438cd833e6dffffffff003375e002024606c002606c0046eacc0d0004c0d0008c0c8004c0a8010cdc199b83337040029032240c4903219980180080426103d8798000302f006302d005222323232323232323253330323375e0020122646464646464a66607066ebc00c02c4c94ccc0f0c0fc0284c8c8c94ccc0fcc1080084c8c94ccc0f8cdc7802a45001533303e533303e3371200e002266e21200000714a026466e000200054ccc10402c5200013301801300b1616375a607e0046eb8c0f400458c100004dd5981e0011bae303a00116303d00916375a60780026078004607400260640046072016606e0142c606c002606c0046eacc0d0004c0d0008c0c8004c0a8008c0c4010c0bc00cc004004888c8c8c8c8c8c8c8c94ccc0c0cdd7800a6103d8798000132323232323253330363375e006016264a666074607a0142646464a66607a608000426464a66607866e3c015221001533303c533303c3371200e002266e21200000714a026466e000200054ccc0fc02c52000133301701701300b1616375a607a0046eb8c0ec00458c0f8004dd5981d0011bae303800116303b00916375a6074002607400460700026060004606e014606a0122c606800260680046eacc0c8004c0c8008c0c0004c0a0008c0bc00cc0b4008ccc8c0040048894ccc0a800852809919299981498018010a511333005005001003302e003375c605800497ae1011e581c15df89fe62968415bac4de9d8576da39c34db4717f46332572aca3eb00811e581c53391ebae9fa352a1108e2769df9baf0d3efcab0f49404bd6ac56bd400119805806800999919191800800911299981419b89480500044c8ccc010010004cdc080124028646464646464646464606e002606c002606a00260680026066002606400260620026060002605e002605c0042660080040026002002444a66604c66e1c0052000100213233300400400133702004900118160010090031bac3027001301f01832323374a9002198131ba90014bd701b94001376600260480026038a66603c66e1d2002301d011101116375a604400260340282660040086eb8cc060c06804d2002301a0133001001222533301f00214a026464a66603c66e3c00800c528899980280280080198118019bae30210023758603a002603a002603800260360026034002603200260300046eb0c058004c058004c054004c03000cc048004c048008c040004c02000c52616320053323232232533300e3370e9000000899191919299980a980c00109924c6600e0064649319299980a19b87480000044c8c8c8c94ccc06cc0780084c9263253330193370e9000000899191919299981018118010991924c64a66603e66e1d20000011323253330243027002132498c94ccc088cdc3a400000226464a66604e605400426493180d8008b181400098100010a99981119b87480080044c8c8c8c8c8c94ccc0acc0b800852616375a605800260580046eb4c0a8004c0a8008dd6981400098100010b18100008b1812800980e8018a99980f99b874800800454ccc088c07400c5261616301d00230140031630210013021002301f001301700416301700316375a60380026038004603400260240042c60240022c6eb8c058004c058008dd6180a00098060010b1806000980080091129998080010a4c264666008008602800600460026024004464a66601666e1d20000011323253330103013002149858dd7180880098048010a99980599b87480080044c8c94ccc040c04c00852616375c602200260120042c60120020086400664a66601266e1d200000113232533300e3011002149858dd6980780098038018a99980499b874800800454ccc030c01c00c5261616300700233001001480008888cccc01ccdc38008018061199980280299b8000448008c0380040080088c014dd5000918019baa0015734aae7555cf2ab9f5740ae855d101",
        ),
      ),
    );

    refOutput.setScriptRef(jpgAskScript);

    const referenceInput: TransactionUnspentOutput =
      new TransactionUnspentOutput(
        new TransactionInput(
          TransactionId(
            "1693C508B6132E89B932754D657D28B24068FF5FF1715FEC36C010D4D6470B3D",
          ),
          0n,
        ),
        refOutput,
      );

    const params = { ...hardCodedProtocolParams };
    const jpgOutput = new TransactionOutput(
      jpgAddress,
      value.makeValue(1_327_480n, [
        "40fa2aa67258b4ce7b5782f74831d46a84c59a0ff0c28262fab21728436c61794e6174696f6e33373031",
        1n,
      ]),
    );
    jpgOutput.setDatum(
      Datum.newDataHash(
        DatumHash(
          "9ef989c39ec7a452e68eaaa8c26c41cd0e7939909a3bff0ac823d3f22c7b0650",
        ),
      ),
    );
    const jpgUtxo = new TransactionUnspentOutput(
      new TransactionInput(
        TransactionId(
          "db1c583fc6117b2370e4d11016a39b3e1f8352455b15bd07c6bf057e0a8e2dde",
        ),
        0n,
      ),

      jpgOutput,
    );
    const redeemer = PlutusData.fromCbor(HexBlob("d8799f00ff"));
    const datum = PlutusData.fromCbor(
      HexBlob(
        "d8799f9fd8799fd8799fd8799f581c1d1c186d5bc22eb56035c37e370f0dcc2c300e8e5f0fa46a6bfdda99ffd8799fd8799fd8799f581ca03de54eefd4acaf0e40dd1ca949fbcd2f6658f9703c8f59ca968a76ffffffff1a01c90030ffd8799fd8799fd8799f581c6a4ee8e9e3913b2952b6f69f667fdc47184f55dcb4f8c678cf59b9deffd8799fd8799fd8799f581c591f2f3dae1f4c91c4edce5b26a93ac25b3f813e245ac19db95d9089ffffffff1a213436b0ffff581c6a4ee8e9e3913b2952b6f69f667fdc47184f55dcb4f8c678cf59b9deff",
      ),
    );
    const collateralUtxo = new TransactionUnspentOutput(
      new TransactionInput(
        TransactionId(
          "69b685a7de3799cf778714ed2dee97dab7a983106caf75c9f752afc20399a29c",
        ),
        5n,
      ),
      new TransactionOutput(inputAddress, value.makeValue(5_000_000n)),
    );
    // This tx was built with base = 44
    if (params.minFeeReferenceScripts) params.minFeeReferenceScripts.base = 44;

    const tx = await new TxBuilder(hardCodedProtocolParams)
      .addUnspentOutputs(utxos)
      .provideCollateral([collateralUtxo])
      .useEvaluator(makeUplcEvaluator(params, 1, 1))
      .setChangeAddress(outputAddress)
      .setNetworkId(NetworkId.Mainnet)
      .addInput(jpgUtxo, redeemer, datum)
      .addReferenceInput(referenceInput)
      .setValidUntil(Slot(140370206))
      .lockAssets(
        Address.fromBech32(
          "addr1xxzvcf02fs5e282qk3pmjkau2emtcsj5wrukxak3np90n2evjel5h55fgjcxgchp830r7h2l5msrlpt8262r3nvr8eksg6pw3p",
        ),
        value.makeValue(11_980_000n),
        PlutusData.fromCbor(
          HexBlob(
            "582067f5229ae335a0f6331ee86b3b4a31c0c9bcdb41a591663acec78a0ab62be174",
          ),
        ),
      )
      .payAssets(
        Address.fromBech32(
          "addr1qyw3cxrdt0pzadtqxhphudc0phxzcvqw3e0slfr2d07a4xdq8hj5am754jhsusxarj55n77d9an937ts8j84nj5k3fmqddwtss",
        ),
        value.makeValue(29_950_000n),
      )
      .payAssets(
        Address.fromBech32(
          "addr1q94ya68fuwgnk22jkmmf7enlm3r3sn64mj6033nceavmnhjeruhnmtslfjgufmwwtvn2jwkztvlcz03yttqemw2ajzysscv93x",
        ),
        value.makeValue(557_070_000n),
      )
      .complete();

    // TODO: Double check that this is accurate.
    expect(tx.body().fee().toString()).toEqual("287643");
  });

  // The following test is based on the below transaction, which was a transaction built by JPG Store. It created a fee that was too small.
  // 84a50082825820f4646e385964a642bee6ced21115ee6560cb6d7d99302db89319013a0b5e641900825820245202665911774b64bd1941f33abd23bcedd7918ccfa141c2c911810df1454400018283583931c727443d77df6cff95dca383994f4c3024d03ff56b02ecc22b0f3f652c967f4bd28944b06462e13c5e3f5d5fa6e03f8567569438cd833e6d821a00151c56a1581cccb2b25e5fd18224ea931a3812e5888716d9c08cd8871ff0ab3dc2faa1581a456d706f7761466f756e64696e67436f6d6d756e697479383333015820440f5b899c44c58bfd73c3283e8d72601ac39e178f854c2d52a80f9ef6ab2bec825839011c899db8a0539f39dc408fa8b1d09c29d214504ad57f10d7c355f90372b3acda54e7e9f23a683f519eda1286afc43ad1203a4e6204ceb5a71a3a0cc5e8021a0002dc15031a085de5fd0758205fa5ee64ef9dce3fbbb9e35c3eab5244c445d60364ef6993fbfc3a544eb24c03a0f5a5181e61361832784064383739396639666438373939666438373939666438373939663538316331633839396462386130353339663339646334303866613862316430396332396432183378403134353034616435376631306437633335356639303366666438373939666438373939666438373939663538316337326233616364613534653765396632336118347840363833663531396564613132383661666334336164313230336134653632303463656235613766666666666666663161316139336534653066666666353831631835783b316338393964623861303533396633396463343038666138623164303963323964323134353034616435376631306437633335356639303366662c

  it("should correctly calculate fee without script", async () => {
    const outputAddress = Address.fromBech32(
      "addr1qywgn8dc5pfe7wwugz863vwsns5ay9zsft2h7yxhcd2ljqmjkwkd5488a8er56pl2x0d5y5x4lzr45fq8f8xypxwkknss5gs29",
    );
    const jpgAddress = Address.fromBech32(
      "addr1x8rjw3pawl0kelu4mj3c8x20fsczf5pl744s9mxz9v8n7efvjel5h55fgjcxgchp830r7h2l5msrlpt8262r3nvr8ekstg4qrx",
    );

    const utxos = [
      new TransactionUnspentOutput(
        new TransactionInput(
          TransactionId(
            "F4646E385964A642BEE6CED21115EE6560CB6D7D99302DB89319013A0B5E6419",
          ),
          0n,
        ),
        new TransactionOutput(
          Address.fromBech32(
            "addr1qxjdqrhk950rdmtfrpy09rlwlm3hpg9jnvd66ahwt6nkdhmjkwkd5488a8er56pl2x0d5y5x4lzr45fq8f8xypxwkknstgmy7e",
          ),
          value.makeValue(2_000_000n, [
            "ccb2b25e5fd18224ea931a3812e5888716d9c08cd8871ff0ab3dc2fa456d706f7761466f756e64696e67436f6d6d756e697479383333",
            1n,
          ]),
        ),
      ),
      new TransactionUnspentOutput(
        new TransactionInput(
          TransactionId(
            "245202665911774b64bd1941f33abd23bcedd7918ccfa141c2c911810df14544",
          ),
          0n,
        ),
        new TransactionOutput(
          Address.fromBech32(
            "addr1qxzvpmq475jnhxjvgjjmwy0zd5z6j0ueucaqaq46vv4gznmjkwkd5488a8er56pl2x0d5y5x4lzr45fq8f8xypxwkkns5mspfr",
          ),
          value.makeValue(973486547n),
        ),
      ),
    ];

    const metadata: Map<bigint, string> = new Map();
    metadata.set(30n, "6");
    metadata.set(
      50n,
      "d8799f9fd8799fd8799fd8799f581c1c899db8a0539f39dc408fa8b1d09c29d2",
    );
    metadata.set(
      51n,
      "14504ad57f10d7c355f903ffd8799fd8799fd8799f581c72b3acda54e7e9f23a",
    );
    metadata.set(
      52n,
      "683f519eda1286afc43ad1203a4e6204ceb5a7ffffffff1a1a93e4e0ffff581c",
    );
    metadata.set(
      53n,
      "1c899db8a0539f39dc408fa8b1d09c29d214504ad57f10d7c355f903ff,",
    );

    const tx = await new TxBuilder(hardCodedProtocolParams)
      .addUnspentOutputs(utxos)
      .lockAssets(
        jpgAddress,
        value.makeValue(1_383_510n, [
          "ccb2b25e5fd18224ea931a3812e5888716d9c08cd8871ff0ab3dc2fa456d706f7761466f756e64696e67436f6d6d756e697479383333",
          1n,
        ]),
        Datum.newDataHash(
          DatumHash(
            "440F5B899C44C58BFD73C3283E8D72601AC39E178F854C2D52A80F9EF6AB2BEC",
          ),
        ) as unknown as Datum, // TODO: why is this type assertion necessary?
      )
      .setChangeAddress(outputAddress)
      .setNetworkId(NetworkId.Mainnet)
      .setAuxiliaryData(
        AuxiliaryData.fromCore({
          blob: metadata,
        }),
      )
      .setValidUntil(Slot(180371453))
      .complete();

    expect(tx.body().fee().toString()).toEqual("192121");
  });

  // Based on this tx
  //84aa00828258207f11d088de6c214c25dbeff5a98ef5cb4f34741c062ead606859bee58ae0794d00825820bb59b5d26894bec65b28df04ba2c9bb1277f06214098ecfd5c353db90579943001018283583931c727443d77df6cff95dca383994f4c3024d03ff56b02ecc22b0f3f652c967f4bd28944b06462e13c5e3f5d5fa6e03f8567569438cd833e6d821a001430a2a1581c1234b07cb890b0227e18fc488888164a57cb7fa108e392a1c7b77f1ca14d4d6f6e6b6579414441343334300158207ae634387c2b9765e1e1d5a392a90b53a7a89f1336c3d12e0a97b62f38929ebf82583901f614e24277457a05bc8972f2ed359b40259e9ce2212a15ba86b736e8bbf05debfa3da5bdb2f803f56ac7bec305767f51ff48de761d9a6c751a6d9497e7021a00072df2031a0871a588075820b5c4edf8bc04a21ea012858342a3c88de6c10bc261b7ae4ca00b68a626b11b820b5820a9025260d96eb350009d716ae946844bdc7c5c50e5ef1640d697c1893dfda2400d81825820bb59b5d26894bec65b28df04ba2c9bb1277f06214098ecfd5c353db905799430020e81581c95421e43490410b5d6cb305ccfbc6496b63852aa03542c704c03849a1082583901f614e24277457a05bc8972f2ed359b40259e9ce2212a15ba86b736e8bbf05debfa3da5bdb2f803f56ac7bec305767f51ff48de761d9a6c751a00418655111a000ac4eba40082825820a1c6bf6ebde14b2beba42558413b07c32646ed6d7728ff790f7e3f55eecfec555840389154853b66a98902eb618b429359fa5f8f7aac76f7e7bce03efd21e36e623bd437ebe17593ff000c53a4fa8867b345b15078e1dd29cd98d4bec4697fb0a70282582025bb110cabd082ba3caeb5e8e9c2e6cdba842ccf43ad980c18746fef380e2ff55840fffd2ed47ca18749fe0e267af78e7bd752340ee025065d2756729ee73f7b850a9ce721c44fde7146993665d897d414092eb03abe97450707e189014942128e0103815912585912550100003323322333222332233223232333222323332223233333333222222223233322232333322223232332232333222323332223232332233223232333332222233223322332233223322332222323232323232232232325335303833300d3333573466e1cd55cea805a400046666664444446666660ba00c00a0080060040026eb8d5d0a8059bad35742a0146eb8d5d0a8049bae35742a0106eb8d5d0a8039bad357426ae89401c8d4138d4c13ccd5ce2490350543100050499263333573466e1d40112002205423333573466e1d40152000205623504f353050335738921035054310005149926498cccd5cd19b8735573aa004900011980819191919191919191919191999ab9a3370e6aae75402920002333333333301e33502c232323333573466e1cd55cea80124000466048607e6ae854008c0c4d5d09aba2500223505e35305f3357389201035054310006049926135573ca00226ea8004d5d0a80519a8160169aba150093335503375ca0646ae854020ccd540cdd728191aba1500733502c04835742a00c66a05866aa0b20a2eb4d5d0a8029919191999ab9a3370e6aae754009200023350263232323333573466e1cd55cea80124000466a05c66a08eeb4d5d0a80118261aba135744a00446a0c46a60c666ae712401035054310006449926135573ca00226ea8004d5d0a8011919191999ab9a3370e6aae7540092000233502c33504775a6ae854008c130d5d09aba250022350623530633357389201035054310006449926135573ca00226ea8004d5d09aba2500223505e35305f3357389201035054310006049926135573ca00226ea8004d5d0a80219a8163ae35742a00666a05866aa0b2eb88004d5d0a801181f1aba135744a00446a0b46a60b666ae71241035054310005c49926135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135573ca00226ea8004d5d0a8011919191999ab9a3370ea00290031181198201aba135573ca00646666ae68cdc3a801240084604460946ae84d55cf280211999ab9a3370ea006900111811181a9aba135573ca00a46666ae68cdc3a802240004604a6eb8d5d09aab9e50062350553530563357389201035054310005749926499264984d55cea80089baa001357426ae8940088d4138d4c13ccd5ce249035054310005049926104f13504d35304e3357389201035054350004f4984d55cf280089baa001135573a6ea80044d5d1280089aba25001135744a00226ae8940044d55cf280089baa0012212330010030022001222222222212333333333300100b00a00900800700600500400300220012212330010030022001122123300100300212001122123300100300212001122123300100300212001212222300400521222230030052122223002005212222300100520011232230023758002640026aa072446666aae7c004940388cd4034c010d5d080118019aba200203323232323333573466e1cd55cea801a4000466600e6464646666ae68cdc39aab9d5002480008cc034c0c4d5d0a80119a8098169aba135744a00446a06c6a606e66ae71241035054310003849926135573ca00226ea8004d5d0a801999aa805bae500a35742a00466a01eeb8d5d09aba25002235032353033335738921035054310003449926135744a00226aae7940044dd50009110919980080200180110009109198008018011000899aa800bae75a224464460046eac004c8004d540cc88c8cccd55cf80112804919a80419aa81898031aab9d5002300535573ca00460086ae8800c0b84d5d08008891001091091198008020018900089119191999ab9a3370ea002900011a80418029aba135573ca00646666ae68cdc3a801240044a01046a0526a605466ae712401035054310002b499264984d55cea80089baa001121223002003112200112001232323333573466e1cd55cea8012400046600c600e6ae854008dd69aba135744a00446a0466a604866ae71241035054310002549926135573ca00226ea80048848cc00400c00880048c8cccd5cd19b8735573aa002900011bae357426aae7940088d407cd4c080cd5ce24810350543100021499261375400224464646666ae68cdc3a800a40084a00e46666ae68cdc3a8012400446a014600c6ae84d55cf280211999ab9a3370ea00690001280511a8111a981199ab9c490103505431000244992649926135573aa00226ea8004484888c00c0104488800844888004480048c8cccd5cd19b8750014800880188cccd5cd19b8750024800080188d4068d4c06ccd5ce249035054310001c499264984d55ce9baa0011220021220012001232323232323333573466e1d4005200c200b23333573466e1d4009200a200d23333573466e1d400d200823300b375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c46601a6eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc048c050d5d0a8049bae357426ae8940248cccd5cd19b875006480088c050c054d5d09aab9e500b23333573466e1d401d2000230133016357426aae7940308d407cd4c080cd5ce2481035054310002149926499264992649926135573aa00826aae79400c4d55cf280109aab9e500113754002424444444600e01044244444446600c012010424444444600a010244444440082444444400644244444446600401201044244444446600201201040024646464646666ae68cdc3a800a400446660106eb4d5d0a8021bad35742a0066eb4d5d09aba2500323333573466e1d400920002300a300b357426aae7940188d4040d4c044cd5ce2490350543100012499264984d55cea80189aba25001135573ca00226ea80048488c00800c888488ccc00401401000c80048c8c8cccd5cd19b875001480088c018dd71aba135573ca00646666ae68cdc3a80124000460106eb8d5d09aab9e500423500a35300b3357389201035054310000c499264984d55cea80089baa001212230020032122300100320011122232323333573466e1cd55cea80124000466aa016600c6ae854008c014d5d09aba25002235007353008335738921035054310000949926135573ca00226ea8004498480048004448848cc00400c008448004488008488004800488888848cccccc00401c01801401000c0088004448c8c00400488cc00cc008008004cc8ccc888c8cc88c8cc88c8c8c8c8c8c8c8c8c8c8cc88ccc888ccc888ccc888cccccccc88888888cc88ccccc88888cccc8888cc88cc88cc88ccc888cc88cc88ccc888cc88cc88cc88cc88c8c8c8cc88c8c8c8c8cccc8888c8cc88c8c8c888c8c8c8c8c888c94cd4c13c00c54cd4c1914cd4c190ccd5cd19b8733301c33355301012001500c50283300b533535026353020500122222222220031350604988854cd4d40a00044008884d41912650013530520092222220043530520092222220034800819819441984cd5ce2481154e4654206e6f742073656e7420746f206275796572000651533530645335306433054301d33301c33355301012001500c50283300b35305200922222200650014881004881003305833058301d500850045006106613357389210f53656c6c6572206e6f742070616964000651533530645335306433054301d33301c332233355301212001500e502a3300d001002500100a489004881005004106613357389210c466565206e6f742070616964000651533530645335306453353064333573466e24d4c1480248888880052000065066133054301d33301c33355301012001500c50283300b353052009222222002500148900488100500610661066133573892113526f79616c6974696573206e6f74207061696400065153353064333573466e24c8cc8004c8004ccd54c05c48004c8cd407088ccd407000c004008d4064004cd406c888c00cc008004800488cdc0000a40040029000199aa98080900091299a9833299a9a8179a98131a981200111000911000908348833899a8148010008800a8141a98101a980f001110011111111111005240040cc0ca20cc266ae7124011a4d6f7265207468616e206f6e652073637269707420696e70757400065106510651065106515335306433223530220022222222222533535039333553022120013350262253353503b002210031001503a253353071333573466e3c0300041cc1c84d40f0004540ec00c841cc41c54004d4c14802488888801841984cd5ce2481204e6f2072696768747320746f20706572666f726d207468697320616374696f6e00065135301d001220021533530603305150565001150011505613305233057480a120d00f3018500315335305e3304f5055500115001150551330503305535304b002222222001483403cc05940044d4c12800488888801488d4c05c0048888888888ccd54c0444800488d4c09c008888d4c0c400c88cd4c15000894cd4c1b4ccd5cd19b8f01400106f06e13350300050071007200750290091223355300b120012353550200012233550230023355300e12001235355023001223355026002333535500d0012330564800000488cc15c0080048cc15800520000013355300b12001235355020001223355023002333535500a00123355300f120012353550240012233550270023550110010012233355500801600200123355300f1200123535502400122335502700235500f00100133355500301100200111122233355300612001501d3355300b1200123535502000122335502300235500d001333553006120012235355021002225335305e33355301012001323350152233353500b0032200200200135350090012200133500922533530600021062100105f235355024001223300a00200500610031335021004003501e0013355300b120012353550200012232335502400330010053200135506022533535021001135500d0032213535502600222533530633300c002008133550120070011300600300212212330010030021200132001355057221122253353501b00110022213300500233355300712001005004001112122230030041122122233002005004112122230010041120013200135505222112253353501500115017221335018300400233553006120010040013200135505122112225335350150011350060032213335009005300400233355300712001005004001123535003001220011235350020012200212212330010030021200122333573466e3c008004134130888c8c8c004014c8004d5413c88cd4d4040005200022353550150022253353052333573466e3c00802415014c4c01c0044c01800cc8004d5413888cd4d403c005200022353550140022253353051333573466e3c00801c14c14840044c01800c8cd411800520022212330010030022001222222222212333333333300100b00a00900800700600500400300220012212330010030022001222123330010040030022001112200212212233001004003120011122123300100300211200122123300100300220011212230020031122001120011221233001003002120011221233001003002120011221233001003002120011212223003004112220021122200112001212222300400521222230030052122223002005212222300100520012212330010030022001212222222300700822122222223300600900821222222230050081222222200412222222003221222222233002009008221222222233001009008200121223002003222122333001005004003200121223002003212230010032001122002122001200122222212333333001007006005004003002200122353500f002223535011003223253353017333573466e1c01400c06406054cd4c05cccd5cd19b870040020190181019150011500115335301633330080040030020011017101822353500e0022235350100032233330070040030020012222333573466e24cdc100200099b8200200301401322353500c00222353500e003223300c3370400800466e0800c00488d4d402c00888d4d403400c88cc02ccdc099b820040013370400400666e0800c00488cdc00010008998012410112f49001099800a410112f49001111980199b820025335300a333573466e1c005200000c00b14800054cd4c028ccd5cd19b890014800002c03052002133702900024004a66a6014666ae68cdc4000a4000018016266e052000001100122325335300a333573466e1c009200000c00b135006353004335738920103505433000054984cd4020cdc2001a80099b84002500113300853353009333573466e20009200000b00a13370290000010801299a9804999ab9a337100029000005805099b8148000004400448004800449848848cc00400c00848004c8004d540108894cd4c010ccd5cd19b870014800001801440084cc00c004cdc2801000891001091000900088919180080091198019801001000a451c70e60f3b5ea7153e0acc7a803e4401d44b8ed1bae1c7baaad1a62a7200010481d8799f581c95421e43490410b5d6cb305ccfbc6496b63852aa03542c704c03849a1a0ee6b280581c1234b07cb890b0227e18fc488888164a57cb7fa108e392a1c7b77f1c4d4d6f6e6b657941444134333430581c535596e9a0a7f6df85f6be951ed8971b92a4122f39c183d3994d0d391819ff0581840000d87a80821a000b22a61a0a719aa7f5a8181e61361832784064383739396639666438373939666438373939666438373939663538316335333535393665396130613766366466383566366265393531656438393731623932183378406134313232663339633138336433393934643064333966666438373939666438373939666438373939663538316337343561333830643230393364396232383318347840366433623235383334356132636164386562373761366134373436353930323330393735336566666666666666663161303030663432343066666438373939661835784064383739396664383739396635383163663631346532343237373435376130356263383937326632656433353962343032353965396365323231326131356261183678403836623733366538666664383739396664383739396664383739396635383163626266303564656266613364613562646232663830336635366163376265633318377840303537363766353166663438646537363164396136633735666666666666666631613030326463366330666666663538316366363134653234323737343537611838782d30356263383937326632656433353962343032353965396365323231326131356261383662373336653866662c
  //
  it("should correctly calculate fee with script", async () => {
    const outputAddress = Address.fromBech32(
      "addr1q8mpfcjzwazh5pdu39e09mf4ndqzt85uugsj59d6s6mnd69m7pw7h73a5k7m97qr744v00krq4m8750lfr08v8v6d36s3kthsj",
    );
    const jpgBuysellAddress = Address.fromBech32(
      "addr1w999n67e86jn6xal07pzxtrmqynspgx0fwmcmpua4wc6yzsxpljz3",
    );
    const jpgAskAddress = Address.fromBech32(
      "addr1x8rjw3pawl0kelu4mj3c8x20fsczf5pl744s9mxz9v8n7efvjel5h55fgjcxgchp830r7h2l5msrlpt8262r3nvr8ekstg4qrx",
    );
    const inputAddress = Address.fromBech32(
      "addr1q8mpfcjzwazh5pdu39e09mf4ndqzt85uugsj59d6s6mnd69m7pw7h73a5k7m97qr744v00krq4m8750lfr08v8v6d36s3kthsj",
    );

    const utxos = [
      new TransactionUnspentOutput(
        new TransactionInput(
          TransactionId(
            "3a6e908226c3e85d05c9ab76d38786ed7ba84cd920dd320baea85964e17d921c",
          ),
          1n,
        ),

        new TransactionOutput(inputAddress, value.makeValue(1_838_524_343n)),
      ),
    ];

    const jpgBuySellScript = Script.newPlutusV1Script(
      PlutusV1Script.fromCbor(
        HexBlob(
          "5912585912550100003323322333222332233223232333222323332223233333333222222223233322232333322223232332232333222323332223232332233223232333332222233223322332233223322332222323232323232232232325335303833300d3333573466e1cd55cea805a400046666664444446666660ba00c00a0080060040026eb8d5d0a8059bad35742a0146eb8d5d0a8049bae35742a0106eb8d5d0a8039bad357426ae89401c8d4138d4c13ccd5ce2490350543100050499263333573466e1d40112002205423333573466e1d40152000205623504f353050335738921035054310005149926498cccd5cd19b8735573aa004900011980819191919191919191919191999ab9a3370e6aae75402920002333333333301e33502c232323333573466e1cd55cea80124000466048607e6ae854008c0c4d5d09aba2500223505e35305f3357389201035054310006049926135573ca00226ea8004d5d0a80519a8160169aba150093335503375ca0646ae854020ccd540cdd728191aba1500733502c04835742a00c66a05866aa0b20a2eb4d5d0a8029919191999ab9a3370e6aae754009200023350263232323333573466e1cd55cea80124000466a05c66a08eeb4d5d0a80118261aba135744a00446a0c46a60c666ae712401035054310006449926135573ca00226ea8004d5d0a8011919191999ab9a3370e6aae7540092000233502c33504775a6ae854008c130d5d09aba250022350623530633357389201035054310006449926135573ca00226ea8004d5d09aba2500223505e35305f3357389201035054310006049926135573ca00226ea8004d5d0a80219a8163ae35742a00666a05866aa0b2eb88004d5d0a801181f1aba135744a00446a0b46a60b666ae71241035054310005c49926135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135573ca00226ea8004d5d0a8011919191999ab9a3370ea00290031181198201aba135573ca00646666ae68cdc3a801240084604460946ae84d55cf280211999ab9a3370ea006900111811181a9aba135573ca00a46666ae68cdc3a802240004604a6eb8d5d09aab9e50062350553530563357389201035054310005749926499264984d55cea80089baa001357426ae8940088d4138d4c13ccd5ce249035054310005049926104f13504d35304e3357389201035054350004f4984d55cf280089baa001135573a6ea80044d5d1280089aba25001135744a00226ae8940044d55cf280089baa0012212330010030022001222222222212333333333300100b00a00900800700600500400300220012212330010030022001122123300100300212001122123300100300212001122123300100300212001212222300400521222230030052122223002005212222300100520011232230023758002640026aa072446666aae7c004940388cd4034c010d5d080118019aba200203323232323333573466e1cd55cea801a4000466600e6464646666ae68cdc39aab9d5002480008cc034c0c4d5d0a80119a8098169aba135744a00446a06c6a606e66ae71241035054310003849926135573ca00226ea8004d5d0a801999aa805bae500a35742a00466a01eeb8d5d09aba25002235032353033335738921035054310003449926135744a00226aae7940044dd50009110919980080200180110009109198008018011000899aa800bae75a224464460046eac004c8004d540cc88c8cccd55cf80112804919a80419aa81898031aab9d5002300535573ca00460086ae8800c0b84d5d08008891001091091198008020018900089119191999ab9a3370ea002900011a80418029aba135573ca00646666ae68cdc3a801240044a01046a0526a605466ae712401035054310002b499264984d55cea80089baa001121223002003112200112001232323333573466e1cd55cea8012400046600c600e6ae854008dd69aba135744a00446a0466a604866ae71241035054310002549926135573ca00226ea80048848cc00400c00880048c8cccd5cd19b8735573aa002900011bae357426aae7940088d407cd4c080cd5ce24810350543100021499261375400224464646666ae68cdc3a800a40084a00e46666ae68cdc3a8012400446a014600c6ae84d55cf280211999ab9a3370ea00690001280511a8111a981199ab9c490103505431000244992649926135573aa00226ea8004484888c00c0104488800844888004480048c8cccd5cd19b8750014800880188cccd5cd19b8750024800080188d4068d4c06ccd5ce249035054310001c499264984d55ce9baa0011220021220012001232323232323333573466e1d4005200c200b23333573466e1d4009200a200d23333573466e1d400d200823300b375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c46601a6eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc048c050d5d0a8049bae357426ae8940248cccd5cd19b875006480088c050c054d5d09aab9e500b23333573466e1d401d2000230133016357426aae7940308d407cd4c080cd5ce2481035054310002149926499264992649926135573aa00826aae79400c4d55cf280109aab9e500113754002424444444600e01044244444446600c012010424444444600a010244444440082444444400644244444446600401201044244444446600201201040024646464646666ae68cdc3a800a400446660106eb4d5d0a8021bad35742a0066eb4d5d09aba2500323333573466e1d400920002300a300b357426aae7940188d4040d4c044cd5ce2490350543100012499264984d55cea80189aba25001135573ca00226ea80048488c00800c888488ccc00401401000c80048c8c8cccd5cd19b875001480088c018dd71aba135573ca00646666ae68cdc3a80124000460106eb8d5d09aab9e500423500a35300b3357389201035054310000c499264984d55cea80089baa001212230020032122300100320011122232323333573466e1cd55cea80124000466aa016600c6ae854008c014d5d09aba25002235007353008335738921035054310000949926135573ca00226ea8004498480048004448848cc00400c008448004488008488004800488888848cccccc00401c01801401000c0088004448c8c00400488cc00cc008008004cc8ccc888c8cc88c8cc88c8c8c8c8c8c8c8c8c8c8cc88ccc888ccc888ccc888cccccccc88888888cc88ccccc88888cccc8888cc88cc88cc88ccc888cc88cc88ccc888cc88cc88cc88cc88c8c8c8cc88c8c8c8c8cccc8888c8cc88c8c8c888c8c8c8c8c888c94cd4c13c00c54cd4c1914cd4c190ccd5cd19b8733301c33355301012001500c50283300b533535026353020500122222222220031350604988854cd4d40a00044008884d41912650013530520092222220043530520092222220034800819819441984cd5ce2481154e4654206e6f742073656e7420746f206275796572000651533530645335306433054301d33301c33355301012001500c50283300b35305200922222200650014881004881003305833058301d500850045006106613357389210f53656c6c6572206e6f742070616964000651533530645335306433054301d33301c332233355301212001500e502a3300d001002500100a489004881005004106613357389210c466565206e6f742070616964000651533530645335306453353064333573466e24d4c1480248888880052000065066133054301d33301c33355301012001500c50283300b353052009222222002500148900488100500610661066133573892113526f79616c6974696573206e6f74207061696400065153353064333573466e24c8cc8004c8004ccd54c05c48004c8cd407088ccd407000c004008d4064004cd406c888c00cc008004800488cdc0000a40040029000199aa98080900091299a9833299a9a8179a98131a981200111000911000908348833899a8148010008800a8141a98101a980f001110011111111111005240040cc0ca20cc266ae7124011a4d6f7265207468616e206f6e652073637269707420696e70757400065106510651065106515335306433223530220022222222222533535039333553022120013350262253353503b002210031001503a253353071333573466e3c0300041cc1c84d40f0004540ec00c841cc41c54004d4c14802488888801841984cd5ce2481204e6f2072696768747320746f20706572666f726d207468697320616374696f6e00065135301d001220021533530603305150565001150011505613305233057480a120d00f3018500315335305e3304f5055500115001150551330503305535304b002222222001483403cc05940044d4c12800488888801488d4c05c0048888888888ccd54c0444800488d4c09c008888d4c0c400c88cd4c15000894cd4c1b4ccd5cd19b8f01400106f06e13350300050071007200750290091223355300b120012353550200012233550230023355300e12001235355023001223355026002333535500d0012330564800000488cc15c0080048cc15800520000013355300b12001235355020001223355023002333535500a00123355300f120012353550240012233550270023550110010012233355500801600200123355300f1200123535502400122335502700235500f00100133355500301100200111122233355300612001501d3355300b1200123535502000122335502300235500d001333553006120012235355021002225335305e33355301012001323350152233353500b0032200200200135350090012200133500922533530600021062100105f235355024001223300a00200500610031335021004003501e0013355300b120012353550200012232335502400330010053200135506022533535021001135500d0032213535502600222533530633300c002008133550120070011300600300212212330010030021200132001355057221122253353501b00110022213300500233355300712001005004001112122230030041122122233002005004112122230010041120013200135505222112253353501500115017221335018300400233553006120010040013200135505122112225335350150011350060032213335009005300400233355300712001005004001123535003001220011235350020012200212212330010030021200122333573466e3c008004134130888c8c8c004014c8004d5413c88cd4d4040005200022353550150022253353052333573466e3c00802415014c4c01c0044c01800cc8004d5413888cd4d403c005200022353550140022253353051333573466e3c00801c14c14840044c01800c8cd411800520022212330010030022001222222222212333333333300100b00a00900800700600500400300220012212330010030022001222123330010040030022001112200212212233001004003120011122123300100300211200122123300100300220011212230020031122001120011221233001003002120011221233001003002120011221233001003002120011212223003004112220021122200112001212222300400521222230030052122223002005212222300100520012212330010030022001212222222300700822122222223300600900821222222230050081222222200412222222003221222222233002009008221222222233001009008200121223002003222122333001005004003200121223002003212230010032001122002122001200122222212333333001007006005004003002200122353500f002223535011003223253353017333573466e1c01400c06406054cd4c05cccd5cd19b870040020190181019150011500115335301633330080040030020011017101822353500e0022235350100032233330070040030020012222333573466e24cdc100200099b8200200301401322353500c00222353500e003223300c3370400800466e0800c00488d4d402c00888d4d403400c88cc02ccdc099b820040013370400400666e0800c00488cdc00010008998012410112f49001099800a410112f49001111980199b820025335300a333573466e1c005200000c00b14800054cd4c028ccd5cd19b890014800002c03052002133702900024004a66a6014666ae68cdc4000a4000018016266e052000001100122325335300a333573466e1c009200000c00b135006353004335738920103505433000054984cd4020cdc2001a80099b84002500113300853353009333573466e20009200000b00a13370290000010801299a9804999ab9a337100029000005805099b8148000004400448004800449848848cc00400c00848004c8004d540108894cd4c010ccd5cd19b870014800001801440084cc00c004cdc2801000891001091000900088919180080091198019801001000a451c70e60f3b5ea7153e0acc7a803e4401d44b8ed1bae1c7baaad1a62a720001",
        ),
      ),
    );
    const params = { ...hardCodedProtocolParams };
    const jpgOutput = new TransactionOutput(
      jpgBuysellAddress,
      value.makeValue(1_724_100n, [
        "1234b07cb890b0227e18fc488888164a57cb7fa108e392a1c7b77f1c4d6f6e6b657941444134333430",
        1n,
      ]),
    );
    jpgOutput.setDatum(
      Datum.newDataHash(
        DatumHash(
          "5e4b6116a37f03d5ef02d3debc1c0fc9743ee8f95093a10fb1edb6f09bd8ede4",
        ),
      ),
    );
    const jpgUtxo = new TransactionUnspentOutput(
      new TransactionInput(
        TransactionId(
          "7f11d088de6c214c25dbeff5a98ef5cb4f34741c062ead606859bee58ae0794d",
        ),
        0n,
      ),

      jpgOutput,
    );
    const redeemer = PlutusData.fromCbor(HexBlob("d87a80"));
    const datum = PlutusData.fromCbor(
      HexBlob(
        "d8799f581c95421e43490410b5d6cb305ccfbc6496b63852aa03542c704c03849a1a0ee6b280581c1234b07cb890b0227e18fc488888164a57cb7fa108e392a1c7b77f1c4d4d6f6e6b657941444134333430581c535596e9a0a7f6df85f6be951ed8971b92a4122f39c183d3994d0d391819ff",
      ),
    );
    const collateralUtxo = new TransactionUnspentOutput(
      new TransactionInput(
        TransactionId(
          "69b685a7de3799cf778714ed2dee97dab7a983106caf75c9f752afc20399a29c",
        ),
        5n,
      ),
      new TransactionOutput(inputAddress, value.makeValue(5_000_000n)),
    );
    // This tx was built with base = 44
    if (params.minFeeReferenceScripts) params.minFeeReferenceScripts.base = 44;

    const auxData = new AuxiliaryData();
    const metadata = new Map<bigint, Metadatum>();
    metadata.set(30n, Metadatum.newText("6"));
    metadata.set(
      50n,
      Metadatum.newText(
        "d8799f9fd8799fd8799fd8799f581c535596e9a0a7f6df85f6be951ed8971b92",
      ),
    );
    metadata.set(
      51n,
      Metadatum.newText(
        "a4122f39c183d3994d0d39ffd8799fd8799fd8799f581c745a380d2093d9b283",
      ),
    );
    metadata.set(
      52n,
      Metadatum.newText(
        "6d3b258345a2cad8eb77a6a47465902309753effffffff1a000f4240ffd8799f",
      ),
    );
    metadata.set(
      53n,
      Metadatum.newText(
        "d8799fd8799f581cf614e24277457a05bc8972f2ed359b40259e9ce2212a15ba",
      ),
    );
    metadata.set(
      54n,
      Metadatum.newText(
        "86b736e8ffd8799fd8799fd8799f581cbbf05debfa3da5bdb2f803f56ac7bec3",
      ),
    );
    metadata.set(
      55n,
      Metadatum.newText(
        "05767f51ff48de761d9a6c75ffffffff1a002dc6c0ffff581cf614e24277457a",
      ),
    );
    metadata.set(
      56n,
      Metadatum.newText("05bc8972f2ed359b40259e9ce2212a15ba86b736e8ff,"),
    );
    auxData.setMetadata(new Metadata(metadata));

    const tx = await new TxBuilder(hardCodedProtocolParams)
      .addUnspentOutputs(utxos)
      .provideCollateral([collateralUtxo])
      .useEvaluator(makeUplcEvaluator(params, 1, 1))
      .setChangeAddress(outputAddress)
      .setNetworkId(NetworkId.Mainnet)
      .addInput(jpgUtxo, redeemer, datum)
      .addRequiredSigner(
        Ed25519KeyHashHex(
          "95421e43490410b5d6cb305ccfbc6496b63852aa03542c704c03849a",
        ),
      )
      .provideScript(jpgBuySellScript)
      .setValidUntil(Slot(140370206))
      .lockAssets(
        jpgAskAddress,
        value.makeValue(1323170n, [
          "1234b07cb890b0227e18fc488888164a57cb7fa108e392a1c7b77f1c4d6f6e6b657941444134333430",
          1n,
        ]),
        DatumHash(
          HexBlob(
            "7AE634387C2B9765E1E1D5A392A90B53A7A89F1336C3D12E0A97B62F38929EBF",
          ),
        ),
      )
      .setAuxiliaryData(auxData)
      .complete();

    // TODO: Ensure that this is accurate.
    expect(tx.body().fee().toString()).toEqual("473990");
  });

  it("should not use coin selection when set to false", async () => {
    // $hosky
    const testAddress = Address.fromBech32(
      "addr1q86ylp637q7hv7a9r387nz8d9zdhem2v06pjyg75fvcmen3rg8t4q3f80r56p93xqzhcup0w7e5heq7lnayjzqau3dfs7yrls5",
    );
    const tx = new TxBuilder(hardCodedProtocolParams)
      .setNetworkId(NetworkId.Testnet)
      .setChangeAddress(testAddress)
      .addWithdrawal(
        RewardAccount.fromCredential(
          testAddress.getProps().paymentPart!,
          NetworkId.Testnet,
        ),
        100_000_000n,
      )
      .addInput(
        new TransactionUnspentOutput(
          new TransactionInput(
            TransactionId(
              "7f11d088de6c214c25dbeff5a98ef5cb4f34741c062ead606859bee58ae0794d",
            ),
            0n,
          ),
          new TransactionOutput(testAddress, value.makeValue(1_000_000n)),
        ),
      )
      .payAssets(testAddress, value.makeValue(48_708_900n));

    try {
      await tx.complete({ useCoinSelection: false });
    } catch (e) {
      expect((e as Error).message).toEqual(
        "Change output has more than inputs provide. Missing coin: 49840323. Missing multiassets: undefined",
      );
    }

    tx.addInput(
      new TransactionUnspentOutput(
        new TransactionInput(TransactionId("0".repeat(64)), 0n),
        new TransactionOutput(testAddress, value.makeValue(50_000_000n)),
      ),
    );

    const txComplete = await tx.complete({ useCoinSelection: false });
    expect(txComplete.body().inputs().values().length).toEqual(2);
    expect(txComplete.body().outputs().length).toEqual(2);
  });

  it("should build a transaction correctly when including a donation to the treasury", async () => {
    // $hosky
    const testAddress = Address.fromBech32(
      "addr1q86ylp637q7hv7a9r387nz8d9zdhem2v06pjyg75fvcmen3rg8t4q3f80r56p93xqzhcup0w7e5heq7lnayjzqau3dfs7yrls5",
    );
    const tx = new TxBuilder(hardCodedProtocolParams)
      .setNetworkId(NetworkId.Testnet)
      .setChangeAddress(testAddress)
      .addUnspentOutputs([
        new TransactionUnspentOutput(
          new TransactionInput(
            TransactionId(
              "7f11d088de6c214c25dbeff5a98ef5cb4f34741c062ead606859bee58ae0794d",
            ),
            0n,
          ),
          new TransactionOutput(testAddress, value.makeValue(1_000_000n)),
        ),
        new TransactionUnspentOutput(
          new TransactionInput(TransactionId("0".repeat(64)), 0n),
          new TransactionOutput(testAddress, value.makeValue(50_000_000n)),
        ),
      ])
      .payAssets(testAddress, value.makeValue(48_708_900n))
      .setDonation(1_000_000n);

    const txComplete = await tx.complete();
    expect(txComplete.toCbor()).toEqual(
      "84a400d90102828258200000000000000000000000000000000000000000000000000000000000000000008258207f11d088de6c214c25dbeff5a98ef5cb4f34741c062ead606859bee58ae0794d00018282583901f44f8751f03d767ba51c4fe988ed289b7ced4c7e832223d44b31bcce2341d750452778e9a0962600af8e05eef6697c83df9f492103bc8b531a02e73d2482583901f44f8751f03d767ba51c4fe988ed289b7ced4c7e832223d44b31bcce2341d750452778e9a0962600af8e05eef6697c83df9f492103bc8b531a00111b57021a00029805161a000f4240a0f5f6",
    );
  });
});
