import {
  Address,
  Ed25519KeyHashHex,
  hardCodedProtocolParams,
  HexBlob,
  NetworkId,
  PaymentAddress,
  PlutusData,
  PlutusV2Script,
  Script,
  Transaction,
  TransactionId,
  TransactionInput,
  TransactionOutput,
  TransactionUnspentOutput,
  TxCBOR,
  Value,
} from "@blaze-cardano/core";

import { isEqualInput, makeValue, TxBuilder } from "../../src";
import { makeUplcEvaluator } from "@blaze-cardano/vm";

class Test_TxBuilder extends TxBuilder {
  constructor() {
    super(hardCodedProtocolParams);
  }

  public test_prepareCollateral(
    { useCoinSelection }: { useCoinSelection: boolean } = {
      useCoinSelection: true,
    },
  ) {
    // Calculate fees manually since we aren't using complete.
    super.calculateFees();
    super.prepareCollateral({ useCoinSelection });
    return this;
  }
}

const changeAddress = Address.fromBech32(
  "addr1z8ax5k9mutg07p2ngscu3chsauktmstq92z9de938j8nqau9fw8fnewskjvp0hg0yk89g5gq4c57nlz3tktjxy3avezqg4csxs",
);

const voidRedeemer = PlutusData.fromCbor(HexBlob("d87a80"));

const orderUtxo = new TransactionUnspentOutput(
  TransactionInput.fromCore({
    index: 0,
    txId: TransactionId(
      "1d58cd9dd9339f752cd1bfa22c041fa951bc4edf7ecad37a272801c310280c4f",
    ),
  }),
  TransactionOutput.fromCore({
    address: PaymentAddress(
      "addr1z8ax5k9mutg07p2ngscu3chsauktmstq92z9de938j8nqau9fw8fnewskjvp0hg0yk89g5gq4c57nlz3tktjxy3avezqg4csxs",
    ),
    value: new Value(4_280_000n).toCore(),
    datum: PlutusData.fromCbor(
      HexBlob(
        "d8799fd8799f581c2f36866691fa75a9aab66dec99f7cc2d297ca09e34d9ce68cde04773ffd8799f581c854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d6644ff1a00138800d8799fd8799fd8799f581c96a76d0f179b25ff5d20435ef093361a7be63ca504b1962f8723d741ffd8799fd8799fd8799f581c854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d6644ffffffffd87980ffd87a9f9f40401a000f4240ff9f581c9a9693a9a37912a5097918f97918d15240c92ab729a0b7c4aa144d774653554e4441451a05af931cffff43d87980ff",
      ),
    ).toCore(),
  }),
);

const walletUtxo = new TransactionUnspentOutput(
  TransactionInput.fromCore({
    index: 0,
    txId: TransactionId(
      "1d58cd9dd9339f752cd1bfa22c041fa951bc4edf7ecad37a272801c310280c4f",
    ),
  }),
  TransactionOutput.fromCore({
    address: PaymentAddress(
      "addr_test1qrp8nglm8d8x9w783c5g0qa4spzaft5z5xyx0kp495p8wksjrlfzuz6h4ssxlm78v0utlgrhryvl2gvtgp53a6j9zngqtjfk6s",
    ),
    value: new Value(4_280_000n).toCore(),
  }),
);

describe("prepareCollateral method", () => {
  it("should prepare the collateral correctly when only one utxo is present", async () => {
    /**
     * This test uses a successful SundaeSwap order cancellation as the test case.
     */
    const txBuilder = new Test_TxBuilder();
    txBuilder.setNetworkId(NetworkId.Mainnet);

    const cancelScript = Script.newPlutusV2Script(
      new PlutusV2Script(
        HexBlob(
          "5909a201000033232323232323223222323232253330093232533300b3005300c375400e264646464646466664444646600200200a4464a6660306026002264646600200201044a66603c00229404c94ccc070cdc79bae302100200414a226600600600260420026eb8c074c068dd50010a99980c1809000899198008009bac301e301b375400644a66603a00229444c94ccc06ccc018018c0800084cc00c00c00452818100008a99980c1806800899198008009bac301e301b375400644a66603a00229404c94ccc06ccc018018c08000852889980180180098100008a99980c180600089919b89375a603c002646660020026eb0c07cc0800092000222533301f002100113330030033022002533301c33007007302100213370000290010800980d1baa00215333018300b00113232533301a3014301b3754002264a66603664a66603e603c0022a666038602c603a002294454ccc070c05cc0740045280b0b1baa300b301d37546016603a6ea80204cdc4800801899b88001003375a603e60386ea80045281807980d9baa3009301b375400c6eb4c074c068dd50010a99980c180500089919299980d180a180d9baa001132533301b32533301f301e0011533301c3016301d00114a22a666038602e603a00229405858dd51805980e9baa3011301d3754010266e2400c0044cdc40018009bad301f301c37540022940c03cc06cdd51807980d9baa006375a603a60346ea80084c8c8cc004004018894ccc078004528099299980e19baf004301d302100214a2266006006002604200266e9520003301c3374a90011980e180e980d1baa0024bd7025eb80c060dd5000980098099baa00e3758602c602e602e602e602e602e602e602e602e60266ea8c01cc04cdd5004980b180b980b980b980b980b980b980b98099baa3007301337540126eacc020c04cdd5180398099baa009230163017001323232325333013300e301437540202646464646464646464646464a666044604a00426464646493192999811980f000899192999814181580109924c64a66604c604200226464a666056605c0042930b1bae302c001302837540042a66604c604000226464a666056605c0042930b1bae302c001302837540042c604c6ea800458c0a4004c094dd50038a999811980e800899191919299981518168010991924c6464646464a66606060660042930b1bad30310013031002375c605e002605e0066eb8c0b4008c8c8c8c8c94ccc0bcc0c800852616375a606000260600046eb8c0b8004c0b8010dd718160018b1bac302b001302b00237586052002604a6ea801c54ccc08cc0600044c8c94ccc0a0c0ac0084c926323232323232323253330303033002149858dd6981880098188011bae302f001302f003375c605a0046464646464a66605e60640042930b1bad30300013030002375c605c002605c0066eb8c0b0008dd618140011bac302600116325333028302b302b0011337606054002605460560022c6eb0c0a4004c094dd50038a999811980b800899192999814181580109924c6464646464a66605a60600042930b1bad302e001302e002375c605800260580046eb8c0a800458dd6181480098129baa007153330233016001132325333028302b002132498c8c8c8c8c8c8c8c94ccc0c0c0cc00852616375a606200260620046eb8c0bc004c0bc00cdd718168011919191919299981798190010a4c2c6eb4c0c0004c0c0008dd7181700098170019bae302c002375860500046eb0c09800458c94ccc0a0c0acc0ac0044cdd81815000981518158008b1bac30290013025375400e2a666046602a00226464a666050605600426493191bae3028002375c604c0022c64a66605060566056002266ec0c0a8004c0a8c0ac00458dd6181480098129baa007163023375400c64a666044603a002264646464a6660526058004264649319299981418118008a99981598151baa00314985854ccc0a0c0880044c8c94ccc0b4c0c000852616375c605c00260546ea800c54ccc0a0c0740044c8c94ccc0b4c0c000852616302e001302a37540062c60506ea80094ccc098c084c09cdd5001899191919299981698180010991924c64a666058604e00226464a666062606800426493192999817981500089919299981a181b80109924c60440022c606a00260626ea800854ccc0bcc0a40044c8c8c8c8c8c94ccc0e0c0ec00852616375a607200260720046eb4c0dc004c0dc008dd6981a80098189baa00216302f37540022c6064002605c6ea800c54ccc0b0c09800454ccc0bcc0b8dd50018a4c2c2c60586ea8008c06c00c58c0b8004c0b8008c0b0004c0a0dd50018b0b18150009815001181400098121baa00815333022301c00115333025302437540102930b0b18111baa007300e00a325333020301b0011323253330253028002149858dd7181300098111baa00c15333020301a00115333023302237540182930b0b18101baa00b163023001302300230210013021002301f001301f002375a603a002603a004603600260360046032002602a6ea804058c00400488c94ccc050c03c0044c8c94ccc064c07000852616375c6034002602c6ea800854ccc050c0380044c8c94ccc064c0700084c926330060012330060060011637586034002602c6ea800854ccc050c0240044c8c94ccc064c0700084c926330060012330060060011637586034002602c6ea800854ccc050c0200044c8c8c8c94ccc06cc0780084c92633008001233008008001163758603800260380046eb4c068004c058dd50010a99980a180380089919299980c980e0010a4c2c6eb4c068004c058dd50010a99980a180300089919299980c980e0010a4c2c6eb4c068004c058dd50010a99980a19b87480300044c8c94ccc064c07000852616375c6034002602c6ea800858c050dd500091191980080080191299980b8008a4c26466006006603600460066032002464a666022601800226464a66602c60320042930b1bae3017001301337540042a666022601600226464a66602c60320042930b1bae3017001301337540042c60226ea8004dc3a40146e1d2008370e90031b87480104c8ccc004004dd5980198071baa3002300e37540089408894ccc04400840044c8ccc010010c05400ccc88c94ccc048c034c04cdd500189929998099806980a1baa001132533301400714a2266e3c004048dd7180c180a9baa001002301730143754006002200860200026eb4c044004c04c0088c0400048c03cc040c040c040c040c040c0400045261365632533300830030011533300b300a37540082930b0a99980418010008a99980598051baa00414985858c020dd50019b8748008dc3a40006eb80055cd2ab9d5573caae7d5d02ba1574498011e581c99e5aacf401fed0eb0e2993d72d423947f42342e8f848353d03efe610001",
        ),
      ),
    );

    // Reference UTXO.
    const refUtxo = new TransactionUnspentOutput(
      TransactionInput.fromCore({
        index: 0,
        txId: TransactionId(
          "f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf2",
        ),
      }),
      TransactionOutput.fromCore({
        address: PaymentAddress(
          "addr1q94mzj4pg3ea2wvwwszhljlwxeh42vt8jwxkwzaej089xs3uvkn3hus9cz5ls37v48adr4tql76s2pggphsgqeq90s6s8mehcd",
        ),
        value: new Value(11_667_170n).toCore(),
        scriptReference: cancelScript.toCore(),
      }),
    );

    txBuilder
      .setChangeAddress(changeAddress)
      .addReferenceInput(refUtxo)
      .addUnspentOutputs([orderUtxo, walletUtxo])
      .addInput(orderUtxo, voidRedeemer);

    // Calculate the fees beforehand since collateral depends on fee amount.
    txBuilder.test_prepareCollateral();

    expect(txBuilder.toCbor()).toEqual(
      "84a600d90102818258201d58cd9dd9339f752cd1bfa22c041fa951bc4edf7ecad37a272801c310280c4f00021a001a56ec0dd90102818258201d58cd9dd9339f752cd1bfa22c041fa951bc4edf7ecad37a272801c310280c4f001082583911fa6a58bbe2d0ff05534431c8e2f0ef2cbdc1602a8456e4b13c8f3077854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d66441a0019cc5e111a0027826212d9010281825820f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf200a105a182000082d87a80821a00d59f801b00000002540be400f5f6",
    );
  });

  it("should prepare the collateral correctly when multiple utxos are present", async () => {
    /**
     * This test uses a successful SundaeSwap order cancellation as the test case.
     */
    const txBuilder = new Test_TxBuilder();
    txBuilder.setNetworkId(NetworkId.Mainnet);

    const cancelScript = Script.newPlutusV2Script(
      new PlutusV2Script(
        HexBlob(
          "5909a201000033232323232323223222323232253330093232533300b3005300c375400e264646464646466664444646600200200a4464a6660306026002264646600200201044a66603c00229404c94ccc070cdc79bae302100200414a226600600600260420026eb8c074c068dd50010a99980c1809000899198008009bac301e301b375400644a66603a00229444c94ccc06ccc018018c0800084cc00c00c00452818100008a99980c1806800899198008009bac301e301b375400644a66603a00229404c94ccc06ccc018018c08000852889980180180098100008a99980c180600089919b89375a603c002646660020026eb0c07cc0800092000222533301f002100113330030033022002533301c33007007302100213370000290010800980d1baa00215333018300b00113232533301a3014301b3754002264a66603664a66603e603c0022a666038602c603a002294454ccc070c05cc0740045280b0b1baa300b301d37546016603a6ea80204cdc4800801899b88001003375a603e60386ea80045281807980d9baa3009301b375400c6eb4c074c068dd50010a99980c180500089919299980d180a180d9baa001132533301b32533301f301e0011533301c3016301d00114a22a666038602e603a00229405858dd51805980e9baa3011301d3754010266e2400c0044cdc40018009bad301f301c37540022940c03cc06cdd51807980d9baa006375a603a60346ea80084c8c8cc004004018894ccc078004528099299980e19baf004301d302100214a2266006006002604200266e9520003301c3374a90011980e180e980d1baa0024bd7025eb80c060dd5000980098099baa00e3758602c602e602e602e602e602e602e602e602e60266ea8c01cc04cdd5004980b180b980b980b980b980b980b980b98099baa3007301337540126eacc020c04cdd5180398099baa009230163017001323232325333013300e301437540202646464646464646464646464a666044604a00426464646493192999811980f000899192999814181580109924c64a66604c604200226464a666056605c0042930b1bae302c001302837540042a66604c604000226464a666056605c0042930b1bae302c001302837540042c604c6ea800458c0a4004c094dd50038a999811980e800899191919299981518168010991924c6464646464a66606060660042930b1bad30310013031002375c605e002605e0066eb8c0b4008c8c8c8c8c94ccc0bcc0c800852616375a606000260600046eb8c0b8004c0b8010dd718160018b1bac302b001302b00237586052002604a6ea801c54ccc08cc0600044c8c94ccc0a0c0ac0084c926323232323232323253330303033002149858dd6981880098188011bae302f001302f003375c605a0046464646464a66605e60640042930b1bad30300013030002375c605c002605c0066eb8c0b0008dd618140011bac302600116325333028302b302b0011337606054002605460560022c6eb0c0a4004c094dd50038a999811980b800899192999814181580109924c6464646464a66605a60600042930b1bad302e001302e002375c605800260580046eb8c0a800458dd6181480098129baa007153330233016001132325333028302b002132498c8c8c8c8c8c8c8c94ccc0c0c0cc00852616375a606200260620046eb8c0bc004c0bc00cdd718168011919191919299981798190010a4c2c6eb4c0c0004c0c0008dd7181700098170019bae302c002375860500046eb0c09800458c94ccc0a0c0acc0ac0044cdd81815000981518158008b1bac30290013025375400e2a666046602a00226464a666050605600426493191bae3028002375c604c0022c64a66605060566056002266ec0c0a8004c0a8c0ac00458dd6181480098129baa007163023375400c64a666044603a002264646464a6660526058004264649319299981418118008a99981598151baa00314985854ccc0a0c0880044c8c94ccc0b4c0c000852616375c605c00260546ea800c54ccc0a0c0740044c8c94ccc0b4c0c000852616302e001302a37540062c60506ea80094ccc098c084c09cdd5001899191919299981698180010991924c64a666058604e00226464a666062606800426493192999817981500089919299981a181b80109924c60440022c606a00260626ea800854ccc0bcc0a40044c8c8c8c8c8c94ccc0e0c0ec00852616375a607200260720046eb4c0dc004c0dc008dd6981a80098189baa00216302f37540022c6064002605c6ea800c54ccc0b0c09800454ccc0bcc0b8dd50018a4c2c2c60586ea8008c06c00c58c0b8004c0b8008c0b0004c0a0dd50018b0b18150009815001181400098121baa00815333022301c00115333025302437540102930b0b18111baa007300e00a325333020301b0011323253330253028002149858dd7181300098111baa00c15333020301a00115333023302237540182930b0b18101baa00b163023001302300230210013021002301f001301f002375a603a002603a004603600260360046032002602a6ea804058c00400488c94ccc050c03c0044c8c94ccc064c07000852616375c6034002602c6ea800854ccc050c0380044c8c94ccc064c0700084c926330060012330060060011637586034002602c6ea800854ccc050c0240044c8c94ccc064c0700084c926330060012330060060011637586034002602c6ea800854ccc050c0200044c8c8c8c94ccc06cc0780084c92633008001233008008001163758603800260380046eb4c068004c058dd50010a99980a180380089919299980c980e0010a4c2c6eb4c068004c058dd50010a99980a180300089919299980c980e0010a4c2c6eb4c068004c058dd50010a99980a19b87480300044c8c94ccc064c07000852616375c6034002602c6ea800858c050dd500091191980080080191299980b8008a4c26466006006603600460066032002464a666022601800226464a66602c60320042930b1bae3017001301337540042a666022601600226464a66602c60320042930b1bae3017001301337540042c60226ea8004dc3a40146e1d2008370e90031b87480104c8ccc004004dd5980198071baa3002300e37540089408894ccc04400840044c8ccc010010c05400ccc88c94ccc048c034c04cdd500189929998099806980a1baa001132533301400714a2266e3c004048dd7180c180a9baa001002301730143754006002200860200026eb4c044004c04c0088c0400048c03cc040c040c040c040c040c0400045261365632533300830030011533300b300a37540082930b0a99980418010008a99980598051baa00414985858c020dd50019b8748008dc3a40006eb80055cd2ab9d5573caae7d5d02ba1574498011e581c99e5aacf401fed0eb0e2993d72d423947f42342e8f848353d03efe610001",
        ),
      ),
    );

    const refUtxo = new TransactionUnspentOutput(
      TransactionInput.fromCore({
        index: 0,
        txId: TransactionId(
          "f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf2",
        ),
      }),
      TransactionOutput.fromCore({
        address: PaymentAddress(
          "addr1q94mzj4pg3ea2wvwwszhljlwxeh42vt8jwxkwzaej089xs3uvkn3hus9cz5ls37v48adr4tql76s2pggphsgqeq90s6s8mehcd",
        ),
        value: new Value(11_667_170n).toCore(),
        scriptReference: cancelScript.toCore(),
      }),
    );

    const orderUtxo = new TransactionUnspentOutput(
      TransactionInput.fromCore({
        index: 0,
        txId: TransactionId(
          "1d58cd9dd9339f752cd1bfa22c041fa951bc4edf7ecad37a272801c310280c4f",
        ),
      }),
      TransactionOutput.fromCore({
        address: PaymentAddress(
          "addr1z8ax5k9mutg07p2ngscu3chsauktmstq92z9de938j8nqau9fw8fnewskjvp0hg0yk89g5gq4c57nlz3tktjxy3avezqg4csxs",
        ),
        value: new Value(1_280_000n).toCore(),
        datum: PlutusData.fromCbor(
          HexBlob(
            "d8799fd8799f581c2f36866691fa75a9aab66dec99f7cc2d297ca09e34d9ce68cde04773ffd8799f581c854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d6644ff1a00138800d8799fd8799fd8799f581c96a76d0f179b25ff5d20435ef093361a7be63ca504b1962f8723d741ffd8799fd8799fd8799f581c854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d6644ffffffffd87980ffd87a9f9f40401a000f4240ff9f581c9a9693a9a37912a5097918f97918d15240c92ab729a0b7c4aa144d774653554e4441451a05af931cffff43d87980ff",
          ),
        ).toCore(),
      }),
    );

    const userUtxo = new TransactionUnspentOutput(
      TransactionInput.fromCore({
        index: 0,
        txId: TransactionId(
          "0ca317ce7d328c7d835f2bcf4ed8299ae239dd102560e99096be22549a21650e",
        ),
      }),
      TransactionOutput.fromCore({
        address: PaymentAddress(changeAddress.toBech32()),
        value: new Value(8_000_000n).toCore(),
      }),
    );

    txBuilder
      .setChangeAddress(changeAddress)
      .addReferenceInput(refUtxo)
      .addUnspentOutputs([orderUtxo, userUtxo, walletUtxo])
      .addInput(orderUtxo, voidRedeemer);

    txBuilder.test_prepareCollateral();

    expect(txBuilder.toCbor()).toEqual(
      "84a600d90102818258201d58cd9dd9339f752cd1bfa22c041fa951bc4edf7ecad37a272801c310280c4f00021a001a56ec0dd90102818258201d58cd9dd9339f752cd1bfa22c041fa951bc4edf7ecad37a272801c310280c4f001082583911fa6a58bbe2d0ff05534431c8e2f0ef2cbdc1602a8456e4b13c8f3077854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d66441a0019cc5e111a0027826212d9010281825820f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf200a105a182000082d87a80821a00d59f801b00000002540be400f5f6",
    );
  });

  it("should prepare the collateral correctly when multiple utxos are present, a collateral is manually set, and coin selection is set to false", async () => {
    /**
     * This test uses a successful SundaeSwap order cancellation as the test case.
     */
    const txBuilder = new Test_TxBuilder();
    txBuilder.setNetworkId(NetworkId.Mainnet);

    const cancelScript = Script.newPlutusV2Script(
      new PlutusV2Script(
        HexBlob(
          "5909a201000033232323232323223222323232253330093232533300b3005300c375400e264646464646466664444646600200200a4464a6660306026002264646600200201044a66603c00229404c94ccc070cdc79bae302100200414a226600600600260420026eb8c074c068dd50010a99980c1809000899198008009bac301e301b375400644a66603a00229444c94ccc06ccc018018c0800084cc00c00c00452818100008a99980c1806800899198008009bac301e301b375400644a66603a00229404c94ccc06ccc018018c08000852889980180180098100008a99980c180600089919b89375a603c002646660020026eb0c07cc0800092000222533301f002100113330030033022002533301c33007007302100213370000290010800980d1baa00215333018300b00113232533301a3014301b3754002264a66603664a66603e603c0022a666038602c603a002294454ccc070c05cc0740045280b0b1baa300b301d37546016603a6ea80204cdc4800801899b88001003375a603e60386ea80045281807980d9baa3009301b375400c6eb4c074c068dd50010a99980c180500089919299980d180a180d9baa001132533301b32533301f301e0011533301c3016301d00114a22a666038602e603a00229405858dd51805980e9baa3011301d3754010266e2400c0044cdc40018009bad301f301c37540022940c03cc06cdd51807980d9baa006375a603a60346ea80084c8c8cc004004018894ccc078004528099299980e19baf004301d302100214a2266006006002604200266e9520003301c3374a90011980e180e980d1baa0024bd7025eb80c060dd5000980098099baa00e3758602c602e602e602e602e602e602e602e602e60266ea8c01cc04cdd5004980b180b980b980b980b980b980b980b98099baa3007301337540126eacc020c04cdd5180398099baa009230163017001323232325333013300e301437540202646464646464646464646464a666044604a00426464646493192999811980f000899192999814181580109924c64a66604c604200226464a666056605c0042930b1bae302c001302837540042a66604c604000226464a666056605c0042930b1bae302c001302837540042c604c6ea800458c0a4004c094dd50038a999811980e800899191919299981518168010991924c6464646464a66606060660042930b1bad30310013031002375c605e002605e0066eb8c0b4008c8c8c8c8c94ccc0bcc0c800852616375a606000260600046eb8c0b8004c0b8010dd718160018b1bac302b001302b00237586052002604a6ea801c54ccc08cc0600044c8c94ccc0a0c0ac0084c926323232323232323253330303033002149858dd6981880098188011bae302f001302f003375c605a0046464646464a66605e60640042930b1bad30300013030002375c605c002605c0066eb8c0b0008dd618140011bac302600116325333028302b302b0011337606054002605460560022c6eb0c0a4004c094dd50038a999811980b800899192999814181580109924c6464646464a66605a60600042930b1bad302e001302e002375c605800260580046eb8c0a800458dd6181480098129baa007153330233016001132325333028302b002132498c8c8c8c8c8c8c8c94ccc0c0c0cc00852616375a606200260620046eb8c0bc004c0bc00cdd718168011919191919299981798190010a4c2c6eb4c0c0004c0c0008dd7181700098170019bae302c002375860500046eb0c09800458c94ccc0a0c0acc0ac0044cdd81815000981518158008b1bac30290013025375400e2a666046602a00226464a666050605600426493191bae3028002375c604c0022c64a66605060566056002266ec0c0a8004c0a8c0ac00458dd6181480098129baa007163023375400c64a666044603a002264646464a6660526058004264649319299981418118008a99981598151baa00314985854ccc0a0c0880044c8c94ccc0b4c0c000852616375c605c00260546ea800c54ccc0a0c0740044c8c94ccc0b4c0c000852616302e001302a37540062c60506ea80094ccc098c084c09cdd5001899191919299981698180010991924c64a666058604e00226464a666062606800426493192999817981500089919299981a181b80109924c60440022c606a00260626ea800854ccc0bcc0a40044c8c8c8c8c8c94ccc0e0c0ec00852616375a607200260720046eb4c0dc004c0dc008dd6981a80098189baa00216302f37540022c6064002605c6ea800c54ccc0b0c09800454ccc0bcc0b8dd50018a4c2c2c60586ea8008c06c00c58c0b8004c0b8008c0b0004c0a0dd50018b0b18150009815001181400098121baa00815333022301c00115333025302437540102930b0b18111baa007300e00a325333020301b0011323253330253028002149858dd7181300098111baa00c15333020301a00115333023302237540182930b0b18101baa00b163023001302300230210013021002301f001301f002375a603a002603a004603600260360046032002602a6ea804058c00400488c94ccc050c03c0044c8c94ccc064c07000852616375c6034002602c6ea800854ccc050c0380044c8c94ccc064c0700084c926330060012330060060011637586034002602c6ea800854ccc050c0240044c8c94ccc064c0700084c926330060012330060060011637586034002602c6ea800854ccc050c0200044c8c8c8c94ccc06cc0780084c92633008001233008008001163758603800260380046eb4c068004c058dd50010a99980a180380089919299980c980e0010a4c2c6eb4c068004c058dd50010a99980a180300089919299980c980e0010a4c2c6eb4c068004c058dd50010a99980a19b87480300044c8c94ccc064c07000852616375c6034002602c6ea800858c050dd500091191980080080191299980b8008a4c26466006006603600460066032002464a666022601800226464a66602c60320042930b1bae3017001301337540042a666022601600226464a66602c60320042930b1bae3017001301337540042c60226ea8004dc3a40146e1d2008370e90031b87480104c8ccc004004dd5980198071baa3002300e37540089408894ccc04400840044c8ccc010010c05400ccc88c94ccc048c034c04cdd500189929998099806980a1baa001132533301400714a2266e3c004048dd7180c180a9baa001002301730143754006002200860200026eb4c044004c04c0088c0400048c03cc040c040c040c040c040c0400045261365632533300830030011533300b300a37540082930b0a99980418010008a99980598051baa00414985858c020dd50019b8748008dc3a40006eb80055cd2ab9d5573caae7d5d02ba1574498011e581c99e5aacf401fed0eb0e2993d72d423947f42342e8f848353d03efe610001",
        ),
      ),
    );

    const refUtxo = new TransactionUnspentOutput(
      TransactionInput.fromCore({
        index: 0,
        txId: TransactionId(
          "f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf2",
        ),
      }),
      TransactionOutput.fromCore({
        address: PaymentAddress(
          "addr1q94mzj4pg3ea2wvwwszhljlwxeh42vt8jwxkwzaej089xs3uvkn3hus9cz5ls37v48adr4tql76s2pggphsgqeq90s6s8mehcd",
        ),
        value: new Value(11_667_170n).toCore(),
        scriptReference: cancelScript.toCore(),
      }),
    );

    const userUtxo = new TransactionUnspentOutput(
      TransactionInput.fromCore({
        index: 0,
        txId: TransactionId(
          "0ca317ce7d328c7d835f2bcf4ed8299ae239dd102560e99096be22549a21650e",
        ),
      }),
      TransactionOutput.fromCore({
        address: PaymentAddress(
          "addr1z8ax5k9mutg07p2ngscu3chsauktmstq92z9de938j8nqau9fw8fnewskjvp0hg0yk89g5gq4c57nlz3tktjxy3avezqg4csxs",
        ),
        value: new Value(8_000_000n).toCore(),
      }),
    );

    txBuilder
      .setChangeAddress(changeAddress)
      .addReferenceInput(refUtxo)
      .addUnspentOutputs([orderUtxo, userUtxo])
      .provideCollateral([userUtxo])
      .addInput(orderUtxo, voidRedeemer);

    txBuilder.test_prepareCollateral({ useCoinSelection: false });

    expect(txBuilder.toCbor()).toEqual(
      "84a600d90102818258201d58cd9dd9339f752cd1bfa22c041fa951bc4edf7ecad37a272801c310280c4f00021a001a56ec0dd90102818258200ca317ce7d328c7d835f2bcf4ed8299ae239dd102560e99096be22549a21650e001082583911fa6a58bbe2d0ff05534431c8e2f0ef2cbdc1602a8456e4b13c8f3077854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d66441a00528f9e111a0027826212d9010281825820f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf200a105a182000082d87a80821a00d59f801b00000002540be400f5f6",
    );
  });

  it("should prepare the collateral correclty when providing explicit collateral utxos and coin selection is set to false", async () => {
    /**
     * This test uses a successful SundaeSwap order cancellation as the test case.
     */
    const txBuilder = new Test_TxBuilder();
    txBuilder.setNetworkId(NetworkId.Mainnet);

    const cancelScript = Script.newPlutusV2Script(
      new PlutusV2Script(
        HexBlob(
          "5909a201000033232323232323223222323232253330093232533300b3005300c375400e264646464646466664444646600200200a4464a6660306026002264646600200201044a66603c00229404c94ccc070cdc79bae302100200414a226600600600260420026eb8c074c068dd50010a99980c1809000899198008009bac301e301b375400644a66603a00229444c94ccc06ccc018018c0800084cc00c00c00452818100008a99980c1806800899198008009bac301e301b375400644a66603a00229404c94ccc06ccc018018c08000852889980180180098100008a99980c180600089919b89375a603c002646660020026eb0c07cc0800092000222533301f002100113330030033022002533301c33007007302100213370000290010800980d1baa00215333018300b00113232533301a3014301b3754002264a66603664a66603e603c0022a666038602c603a002294454ccc070c05cc0740045280b0b1baa300b301d37546016603a6ea80204cdc4800801899b88001003375a603e60386ea80045281807980d9baa3009301b375400c6eb4c074c068dd50010a99980c180500089919299980d180a180d9baa001132533301b32533301f301e0011533301c3016301d00114a22a666038602e603a00229405858dd51805980e9baa3011301d3754010266e2400c0044cdc40018009bad301f301c37540022940c03cc06cdd51807980d9baa006375a603a60346ea80084c8c8cc004004018894ccc078004528099299980e19baf004301d302100214a2266006006002604200266e9520003301c3374a90011980e180e980d1baa0024bd7025eb80c060dd5000980098099baa00e3758602c602e602e602e602e602e602e602e602e60266ea8c01cc04cdd5004980b180b980b980b980b980b980b980b98099baa3007301337540126eacc020c04cdd5180398099baa009230163017001323232325333013300e301437540202646464646464646464646464a666044604a00426464646493192999811980f000899192999814181580109924c64a66604c604200226464a666056605c0042930b1bae302c001302837540042a66604c604000226464a666056605c0042930b1bae302c001302837540042c604c6ea800458c0a4004c094dd50038a999811980e800899191919299981518168010991924c6464646464a66606060660042930b1bad30310013031002375c605e002605e0066eb8c0b4008c8c8c8c8c94ccc0bcc0c800852616375a606000260600046eb8c0b8004c0b8010dd718160018b1bac302b001302b00237586052002604a6ea801c54ccc08cc0600044c8c94ccc0a0c0ac0084c926323232323232323253330303033002149858dd6981880098188011bae302f001302f003375c605a0046464646464a66605e60640042930b1bad30300013030002375c605c002605c0066eb8c0b0008dd618140011bac302600116325333028302b302b0011337606054002605460560022c6eb0c0a4004c094dd50038a999811980b800899192999814181580109924c6464646464a66605a60600042930b1bad302e001302e002375c605800260580046eb8c0a800458dd6181480098129baa007153330233016001132325333028302b002132498c8c8c8c8c8c8c8c94ccc0c0c0cc00852616375a606200260620046eb8c0bc004c0bc00cdd718168011919191919299981798190010a4c2c6eb4c0c0004c0c0008dd7181700098170019bae302c002375860500046eb0c09800458c94ccc0a0c0acc0ac0044cdd81815000981518158008b1bac30290013025375400e2a666046602a00226464a666050605600426493191bae3028002375c604c0022c64a66605060566056002266ec0c0a8004c0a8c0ac00458dd6181480098129baa007163023375400c64a666044603a002264646464a6660526058004264649319299981418118008a99981598151baa00314985854ccc0a0c0880044c8c94ccc0b4c0c000852616375c605c00260546ea800c54ccc0a0c0740044c8c94ccc0b4c0c000852616302e001302a37540062c60506ea80094ccc098c084c09cdd5001899191919299981698180010991924c64a666058604e00226464a666062606800426493192999817981500089919299981a181b80109924c60440022c606a00260626ea800854ccc0bcc0a40044c8c8c8c8c8c94ccc0e0c0ec00852616375a607200260720046eb4c0dc004c0dc008dd6981a80098189baa00216302f37540022c6064002605c6ea800c54ccc0b0c09800454ccc0bcc0b8dd50018a4c2c2c60586ea8008c06c00c58c0b8004c0b8008c0b0004c0a0dd50018b0b18150009815001181400098121baa00815333022301c00115333025302437540102930b0b18111baa007300e00a325333020301b0011323253330253028002149858dd7181300098111baa00c15333020301a00115333023302237540182930b0b18101baa00b163023001302300230210013021002301f001301f002375a603a002603a004603600260360046032002602a6ea804058c00400488c94ccc050c03c0044c8c94ccc064c07000852616375c6034002602c6ea800854ccc050c0380044c8c94ccc064c0700084c926330060012330060060011637586034002602c6ea800854ccc050c0240044c8c94ccc064c0700084c926330060012330060060011637586034002602c6ea800854ccc050c0200044c8c8c8c94ccc06cc0780084c92633008001233008008001163758603800260380046eb4c068004c058dd50010a99980a180380089919299980c980e0010a4c2c6eb4c068004c058dd50010a99980a180300089919299980c980e0010a4c2c6eb4c068004c058dd50010a99980a19b87480300044c8c94ccc064c07000852616375c6034002602c6ea800858c050dd500091191980080080191299980b8008a4c26466006006603600460066032002464a666022601800226464a66602c60320042930b1bae3017001301337540042a666022601600226464a66602c60320042930b1bae3017001301337540042c60226ea8004dc3a40146e1d2008370e90031b87480104c8ccc004004dd5980198071baa3002300e37540089408894ccc04400840044c8ccc010010c05400ccc88c94ccc048c034c04cdd500189929998099806980a1baa001132533301400714a2266e3c004048dd7180c180a9baa001002301730143754006002200860200026eb4c044004c04c0088c0400048c03cc040c040c040c040c040c0400045261365632533300830030011533300b300a37540082930b0a99980418010008a99980598051baa00414985858c020dd50019b8748008dc3a40006eb80055cd2ab9d5573caae7d5d02ba1574498011e581c99e5aacf401fed0eb0e2993d72d423947f42342e8f848353d03efe610001",
        ),
      ),
    );

    const refUtxo = new TransactionUnspentOutput(
      TransactionInput.fromCore({
        index: 0,
        txId: TransactionId(
          "f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf2",
        ),
      }),
      TransactionOutput.fromCore({
        address: PaymentAddress(
          "addr1q94mzj4pg3ea2wvwwszhljlwxeh42vt8jwxkwzaej089xs3uvkn3hus9cz5ls37v48adr4tql76s2pggphsgqeq90s6s8mehcd",
        ),
        value: new Value(11_667_170n).toCore(),
        scriptReference: cancelScript.toCore(),
      }),
    );

    const userUtxo = new TransactionUnspentOutput(
      TransactionInput.fromCore({
        index: 0,
        txId: TransactionId(
          "0ca317ce7d328c7d835f2bcf4ed8299ae239dd102560e99096be22549a21650e",
        ),
      }),
      TransactionOutput.fromCore({
        address: PaymentAddress(
          "addr1z8ax5k9mutg07p2ngscu3chsauktmstq92z9de938j8nqau9fw8fnewskjvp0hg0yk89g5gq4c57nlz3tktjxy3avezqg4csxs",
        ),
        value: new Value(8_000_000n).toCore(),
      }),
    );

    txBuilder
      .setChangeAddress(changeAddress)
      .addReferenceInput(refUtxo)
      .provideCollateral([orderUtxo, userUtxo])
      .addInput(orderUtxo, voidRedeemer);

    txBuilder.test_prepareCollateral({ useCoinSelection: false });

    expect(txBuilder.toCbor()).toEqual(
      "84a600d90102818258201d58cd9dd9339f752cd1bfa22c041fa951bc4edf7ecad37a272801c310280c4f00021a001a56ec0dd90102828258201d58cd9dd9339f752cd1bfa22c041fa951bc4edf7ecad37a272801c310280c4f008258200ca317ce7d328c7d835f2bcf4ed8299ae239dd102560e99096be22549a21650e001082583911fa6a58bbe2d0ff05534431c8e2f0ef2cbdc1602a8456e4b13c8f3077854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d66441a0093de5e111a0027826212d9010281825820f5f1bdfad3eb4d67d2fc36f36f47fc2938cf6f001689184ab320735a28642cf200a105a182000082d87a80821a00d59f801b00000002540be400f5f6",
    );
  });

  it("should not prepare collateral if there are no redeemers", () => {
    const txBuilder = new Test_TxBuilder();
    txBuilder.setNetworkId(NetworkId.Mainnet);

    const userUtxo = new TransactionUnspentOutput(
      TransactionInput.fromCore({
        index: 0,
        txId: TransactionId(
          "0ca317ce7d328c7d835f2bcf4ed8299ae239dd102560e99096be22549a21650e",
        ),
      }),
      TransactionOutput.fromCore({
        address: PaymentAddress(
          "addr1z8ax5k9mutg07p2ngscu3chsauktmstq92z9de938j8nqau9fw8fnewskjvp0hg0yk89g5gq4c57nlz3tktjxy3avezqg4csxs",
        ),
        value: new Value(8_000_000n).toCore(),
      }),
    );

    const orderDatum = orderUtxo.output().datum()?.asInlineData() as PlutusData;

    txBuilder
      .setChangeAddress(changeAddress)
      .addUnspentOutputs([userUtxo])
      .lockLovelace(orderUtxo.output().address(), 1_000_000n, orderDatum);

    txBuilder.test_prepareCollateral();

    expect(txBuilder.toCbor()).toEqual(
      "84a20181a300583911fa6a58bbe2d0ff05534431c8e2f0ef2cbdc1602a8456e4b13c8f3077854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d6644011a001e2fb2028201d81858e1d8799fd8799f581c2f36866691fa75a9aab66dec99f7cc2d297ca09e34d9ce68cde04773ffd8799f581c854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d6644ff1a00138800d8799fd8799fd8799f581c96a76d0f179b25ff5d20435ef093361a7be63ca504b1962f8723d741ffd8799fd8799fd8799f581c854b8e99e5d0b49817dd0f258e545100ae29e9fc515d9723123d6644ffffffffd87980ffd87a9f9f40401a000f4240ff9f581c9a9693a9a37912a5097918f97918d15240c92ab729a0b7c4aa144d774653554e4441451a05af931cffff43d87980ff021a000293e5a0f5f6",
    );
  });

  // Pulled from real-world scenario, where a user is trying to unlock SundaeSwap YF positions with low ADA and high NFT count.
  it("should throw an error if the selected collateral input is not large enough after required collateral is deducted", async () => {
    const usersPosition = Transaction.fromCbor(
      TxCBOR(
        "84a900838258206f2858e276b5acfb136f566947836b72cf3fac13f791e2b0009f62d485dcf63400825820a53d07bd90fefdab90e628da80fcf152e4370abfbaf65ce6f6f64a74c5bab32004825820a53d07bd90fefdab90e628da80fcf152e4370abfbaf65ce6f6f64a74c5bab320000183a30058391173275b9e267fd927bfc14cf653d904d1538ad8869260ab638bf73f5cd7244b4a8777b7dc6909f4640cf02ea4757a557a99fb483b05f87dfe01821a004c4b40a1581ce0302560ced2fdcbfcb2602697df970cd0d6a38f94b32703f51c312ba158200014df102f36866691fa75a9aab66dec99f7cc2d297ca09e34d9ce68cde047731a008f2fa3028201d8185853d8799fd8799f581ccf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d9ff9fd87a9f4653554e444145581c2f36866691fa75a9aab66dec99f7cc2d297ca09e34d9ce68cde047731864ffffff82583901a4365ab5a9b57fb90a1c616d64b467596d9291547c2418610e43776acf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d9821a00d96b9cb838581c016be5325fd988fea98ad422fcfd53e5352cacfced5c106a932a35a4a14342544e1a0003cd9e581c10a49b996e2402269af553a8a96fb8eb90d79e9eca79e2b4223057b6a1444745524f1a06c9f9e0581c13057a460cfd6c33952483d18f09d83a5eba3537ad4250a2c6587f0aa144424c55451a00017337581c160a880d9fc45380737cb7e57ff859763230aab28b3ef6a84007bfcca1444d495241192904581c16fdd33c86af604e837ae57d79d5f0f1156406086db5f16afb3fcf51a14544474f4c441a62590080581c1774343241680e4daef7cbfe3536fc857ce23fb66cd0b66320b2e3dda1454249534f4e1a01312cfe581c1a71dc14baa0b4fcfb34464adc6656d0e562571e2ac1bc990c9ce5f6a144574f4c461b00000002d1e0e3c4581c1d7f33bd23d85e1a25d87d86fac4f199c3197a2f7afeb662a0f34e1ea150776f726c646d6f62696c65746f6b656e1a000d6ed2581c1f4b1b277c9c001c1522727506a2cfb401a0d0ade069b0241f16f07da14248491a001e8480581c25c5de5f5b286073c593edfd77b48abc7a48e5a4f3d4cd9d428ff935a144444547411b000029baea2bb971581c279c909f348e533da5808898f87f9a14bb2c3dfbbacccd631d927a3fa144534e454b18a0581c29d222ce763455e3d7a09a665ce554f00ac89d2e99a1a83d267170c6a1434d494e1a0002fc0e581c2afb448ef716bfbed1dcb676102194c3009bee5399e93b90def9db6aa1454249534f4e1a00a7d8be581c2d7444cf9e317a12e3eb72bf424fd2a0c8fbafedf10e20bfdb4ad8aba1464348454444411a00061a7e581c3b31e746a68c5bef72c0fb9f2185e6b1fad0ea2faaccfeeb275afe91a14552454143481a0b626dc0581c3d77d63dfa6033be98021417e08e3368cc80e67f8d7afa196aaa0b39a14c53746172636820546f6b656e1a00027100581c420000029ad9527271b1b1e3c27ee065c18df70a4a4cfc3093a41a44a14341584f1a02a1c078581c42b39974c406678cfb65a16e0d7ac97d467b0db06ba669ad0942a9f9a145414d454c441a00013880581c438514ae1beb020d35e5389993447cea29637d6272c918017988ef36a1484164615969656c641b0000000165a0bc00581c4a043115b498be47874c6f5f2bd5056e5c7d81c93c6a4c603b526ccea145614d454c4401581c51a5e236c4de3af2b8020442e2a26f454fda3b04cb621c1294a0ef34a144424f4f4b1a00b5baf8581c547ceed647f57e64dc40a29b16be4f36b0d38b5aa3cd7afb286fc094a1476262486f736b791903e6581c577f0b1342f8f8f4aed3388b80a8535812950c7a892495c0ecdf0f1ea1480014df10464c44541844581c59515c449f1ec1d21a4b2d93013337d13b29d74c3a665a11d5b7fc66a14544534c56521b0000000df8475800581c5dac8536653edc12f6f5e1045d8164b9f59998d3bdc300fc92843489a1444e4d4b521b000000060c44a738581c5eee9c6e9cc2701d1af66b3370a108472f0e173e5e70c6c7a0af58f9a24b4372797374616c31303730014b4372797374616c3734303301581c641f0571d02b45b868ac1c479fc8118c5be6744ec3d2c5e13bd888b6a1465a4f4d424945190bb6581c682fe60c9918842b3323c43b5144bc3d52a23bd2fb81345560d73f63a1444e45574d1a02faf080581c6cc5da99ec107947f922e81038b2f5accba43b76d2b1f515673a8c24a24e437261796f6e4372657735343936014e437261796f6e437265773536323201581c6d06570ddd778ec7c0cca09d381eca194e90c8cffa7582879735dbdea1435845521b00000004ad0f58d5581c8434cc23a47cfa0d68d729b480169bfa3f910310a8184f43cfbcc02ca1470014df104c54591a000aaffa581c8483844875ce4d61c2aa459240f277d32081ee08fe0ad16899a0f581a1490014df10544954414e1b0000000110c7035c581c8d0ae3c5b13b47907b16511a540d47436d12dcc96453c0f59089b451a14542524f4f4d1a00497791581c8e1d94b7ac5db949a55720f054534b55b66f9a1f7d5a8a2132427369a14756643476674e4102581c96ad5ab136d2193dda2afb662285b93e48d265e14df59ee0f33925aea1444447454d1a01e0a6e0581c9cb29862cdce7cc8a5eff4b3634d3afa7c8241b04fc4839a372d448aa14953757065724475636b1a058675c8581ca1b253ba5fb215164ad2d729d91222a4dfd857c0b10c8f40c4d10b0ea145414d49524101581caf2e27f580f7f08e93190a81f72462f153026d06450924726645891ba144445249501a7d49264f581cafc910d7a306d20c12903979d4935ae4307241d03245743548e76783a14541534849421b000000030236127e581cb06729158210bf1ba13f8f3d7d422a918d3eaa82561a705552a2568ba1581a4d656c642042616e6b204d616e6167657220763120323233343801581cb2b2efec2dd5923e8e70bdc77cf40f41aafc6676cfa752f37f2ec6fbb81e4e44454741456c656d656e74313632014e44454741456c656d656e74313635014e44454741456c656d656e74313637014e44454741456c656d656e74313638014e44454741456c656d656e74313639014e44454741456c656d656e74313735014e44454741456c656d656e74333331014e44454741456c656d656e74333332014e44454741456c656d656e74333336014e44454741456c656d656e74333337014e44454741456c656d656e74333338014e44454741456c656d656e74333339014e44454741456c656d656e74333430014e44454741456c656d656e74333431014e44454741456c656d656e74333432014e44454741456c656d656e74333433014e44454741456c656d656e74333435014f44454741456c656d656e7431393834014f44454741456c656d656e7432313835014f44454741456c656d656e7432323431014f44454741456c656d656e7432323531014f44454741456c656d656e7432323536014f44454741456c656d656e7432323635014f44454741456c656d656e7432333334014f44454741456c656d656e7432333335014f44454741456c656d656e7432333336014f44454741456c656d656e7432333337014f44454741456c656d656e7432343030014f44454741456c656d656e7432343031014f44454741456c656d656e743234303401581cb6a7467ea1deb012808ef4e87b5ff371e85f7142d7b356a40d9b42a0a1581e436f726e75636f70696173205b76696120436861696e506f72742e696f5d1a442fc95c581cb788fbee71a32d2efc5ee7d151f3917d99160f78fb1e41a1bbf80d8fa1494c454146544f4b454e1a505aca47581cc881c20e49dbaca3ff6cef365969354150983230c39520b917f5cf7ca1444e696b65190e0d581cd030b626219d81673bd32932d2245e0c71ae5193281f971022b23a78a148436172646f67656f1904ec581cdb30c7905f598ed0154de14f970de0f61f0cb3943ed82c891968480aa144434c41501a000445c0581ce1cc6498cdaa972c3dc7b374b6b7cc5e05fb0fe4955a4dd380e4ff0da3582037d16d718e3d53e454a8dd49f32bb0a719647e63bbc65425b3f90c1a298f96aa01582081703303aa3348403e2ceaba4c4fa6c763df5473556905608d3339b3216f11860158209d029762f1ce804c7338757b046d5542f4f1bb83cdca238cf06acdeacd9e98ec01581cea153b5d4864af15a1079a94a0e2486d6376fa28aafad272d15b243aa14a0014df105368617264731a006acfc0581cecd0970cb2d599a8bdb61f6eb597e25eaf34d76bdf8ade17b6a8fa59a14a000de14053483031373901581cf0ff48bbb7bbe9d59a40f1ce90e9e9d0ff5002ec48f232b49ca0fb9aa14e000de140626c61636b776f6c667801581cf43a62fdc3965df486de8a0d32fe800963589c41b38946602a0dc535a144414749581a00823080581cf5f8e854af532d828d00381df799ba6db22d825c9b140e1d5795cf85a14e0014df10447261676f6e476f6c641a545eee57581cf6ac48c64aa7af16434d9f84e014d11fba38525b436acc338ff20b0da1434d74630b581cfbae99b8679369079a7f6f0da14a2cf1c2d6bfd3afdf3a96a64ab67aa1490014df1047454e53581a00075818581cfd5a192b76cb73f004edde3993c31f8846845d858fa29a19b8a19869a14348594e1a00512570581cfed1c459a47cbff56bd7d29c2dde0de3e9bd15cee02b98622fce82f7a24d43617264616e6f436f707065721a05f5e1004d43617264616e6f53696c7665721a000f424082583901a4365ab5a9b57fb90a1c616d64b467596d9291547c2418610e43776acf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d91a0044aa20021a0007a1200b5820dd766a5bb9deba9c3a776817207d81d6515ccdf3e5e4347ea4a2847129efb0400d81825820a53d07bd90fefdab90e628da80fcf152e4370abfbaf65ce6f6f64a74c5bab320000e82581cc0cb190bf8f99d51bd6e08939256ff9b42becb7e3fe01cfa8eb4d4c1581ccf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d91082583901a4365ab5a9b57fb90a1c616d64b467596d9291547c2418610e43776acf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d91a0040d990111a000b71b012818258205af2bc2b1c983f65122d8737755d1de6e88c4d24797fdfac2c01e5156c15256f00a200838258205b19736e711641445a7c6655da989ae04cd3f2408668eb308ad81eda8a830f4f584018f4e84257eb54b32692012854f95fb2df0b24b7649ad0e8fe2061ffa75a58d7ad7581f6f2eadaa656d40f449ac1c20db9e9760f08a0c678ad4b560707e8d70982582049e361ffcdfcb4e9e54d26fcde6c874c1e9231692b89c92190bdd227fe588d4258401c532a55b3c383872dc747cf106760464df1d1e802a021de1bea5daa58d13b80b289e66f47b7a53799fb2614546ab749b0b7524b57396d661ec8604a1ea202008258202056c5bbb7e3d18e7592dc6e42b9c4b0ac415a6898b34ccbca75776bc6ae4d3a5840a215d878fc464be6c84c13d0e1f76b451a5eb8709893d65e4d3bdf31d675a6e04f49c317541f8452e82f352bd9a935aa504318982e18a64eeeeb6e39d4b5c90e0581840000d87a80821a000182311a018144a1f5f6",
      ),
    );

    const usersPositionOutput = usersPosition
      .body()
      .outputs()[0] as TransactionOutput;

    const positionUtxo = TransactionUnspentOutput.fromCore([
      {
        index: 0,
        txId: TransactionId(
          "f1eeae5d97d171913296117859ab801657a96321245c84ff4a4f33ebd4217508",
        ),
      },
      usersPositionOutput.toCore(),
    ]);

    const usersWallet = Transaction.fromCbor(
      TxCBOR(
        "84a400d90102828258208286e6132af7019ea6232417affbc4256ceea1c6ca5be80355a468793a0eda6600825820c97be6f9fa702f69afa829ebbc98c2b557c97ecacb40a65cd2d66ed5c79776c601018482581d61c0cb190bf8f99d51bd6e08939256ff9b42becb7e3fe01cfa8eb4d4c11a004c4b4082583901228938ca5b3f5c0ed1ddb1408f8ac86a8efed099bdf124f15cba2805cf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d91a001e848082583901228938ca5b3f5c0ed1ddb1408f8ac86a8efed099bdf124f15cba2805cf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d9821a00b5b5b2b82e581c016be5325fd988fea98ad422fcfd53e5352cacfced5c106a932a35a4a14342544e1a0003cd9e581c10a49b996e2402269af553a8a96fb8eb90d79e9eca79e2b4223057b6a1444745524f1a06c9f9e0581c13057a460cfd6c33952483d18f09d83a5eba3537ad4250a2c6587f0aa144424c55451a00017337581c160a880d9fc45380737cb7e57ff859763230aab28b3ef6a84007bfcca1444d495241192904581c16fdd33c86af604e837ae57d79d5f0f1156406086db5f16afb3fcf51a14544474f4c441a62590080581c1774343241680e4daef7cbfe3536fc857ce23fb66cd0b66320b2e3dda1454249534f4e1a01312cfe581c1a71dc14baa0b4fcfb34464adc6656d0e562571e2ac1bc990c9ce5f6a144574f4c461b00000002d1e0e3c4581c1d7f33bd23d85e1a25d87d86fac4f199c3197a2f7afeb662a0f34e1ea150776f726c646d6f62696c65746f6b656e1a000d6ed2581c1f4b1b277c9c001c1522727506a2cfb401a0d0ade069b0241f16f07da14248491a001e8480581c279c909f348e533da5808898f87f9a14bb2c3dfbbacccd631d927a3fa144534e454b18a0581c29d222ce763455e3d7a09a665ce554f00ac89d2e99a1a83d267170c6a1434d494e1a0002fc0e581c2afb448ef716bfbed1dcb676102194c3009bee5399e93b90def9db6aa1454249534f4e1a00a7d8be581c2d7444cf9e317a12e3eb72bf424fd2a0c8fbafedf10e20bfdb4ad8aba1464348454444411a00061a7e581c3b31e746a68c5bef72c0fb9f2185e6b1fad0ea2faaccfeeb275afe91a14552454143481a0b626dc0581c3d77d63dfa6033be98021417e08e3368cc80e67f8d7afa196aaa0b39a14c53746172636820546f6b656e1a00027100581c420000029ad9527271b1b1e3c27ee065c18df70a4a4cfc3093a41a44a14341584f1a02a1c078581c438514ae1beb020d35e5389993447cea29637d6272c918017988ef36a1484164615969656c641b0000000165a0bc00581c51a5e236c4de3af2b8020442e2a26f454fda3b04cb621c1294a0ef34a144424f4f4b1a00b5baf8581c547ceed647f57e64dc40a29b16be4f36b0d38b5aa3cd7afb286fc094a1476262486f736b791903e6581c577f0b1342f8f8f4aed3388b80a8535812950c7a892495c0ecdf0f1ea1480014df10464c44541844581c59515c449f1ec1d21a4b2d93013337d13b29d74c3a665a11d5b7fc66a14544534c56521b0000000df8475800581c5eee9c6e9cc2701d1af66b3370a108472f0e173e5e70c6c7a0af58f9a24b4372797374616c31303730014b4372797374616c3734303301581c641f0571d02b45b868ac1c479fc8118c5be6744ec3d2c5e13bd888b6a1465a4f4d424945190bb6581c682fe60c9918842b3323c43b5144bc3d52a23bd2fb81345560d73f63a1444e45574d1a02faf080581c6cc5da99ec107947f922e81038b2f5accba43b76d2b1f515673a8c24a24e437261796f6e4372657735343936014e437261796f6e437265773536323201581c8434cc23a47cfa0d68d729b480169bfa3f910310a8184f43cfbcc02ca1470014df104c54591a000aaffa581c8483844875ce4d61c2aa459240f277d32081ee08fe0ad16899a0f581a1490014df10544954414e1b0000000110c7035c581c8d0ae3c5b13b47907b16511a540d47436d12dcc96453c0f59089b451a14542524f4f4d1a00497791581c8e1d94b7ac5db949a55720f054534b55b66f9a1f7d5a8a2132427369a14756643476674e4102581c96ad5ab136d2193dda2afb662285b93e48d265e14df59ee0f33925aea1444447454d1a01e0a6e0581c9cb29862cdce7cc8a5eff4b3634d3afa7c8241b04fc4839a372d448aa14953757065724475636b1a058675c8581ca0028f350aaabe0545fdcb56b039bfb08e4bb4d8c4d7c3c7d481c235a145484f534b591a0605887d581caf2e27f580f7f08e93190a81f72462f153026d06450924726645891ba144445249501a7d49264f581cafc910d7a306d20c12903979d4935ae4307241d03245743548e76783a14541534849421b000000030236127e581cb06729158210bf1ba13f8f3d7d422a918d3eaa82561a705552a2568ba1581a4d656c642042616e6b204d616e6167657220763120323233343801581cb2b2efec2dd5923e8e70bdc77cf40f41aafc6676cfa752f37f2ec6fbb81e4e44454741456c656d656e74313632014e44454741456c656d656e74313635014e44454741456c656d656e74313637014e44454741456c656d656e74313638014e44454741456c656d656e74313639014e44454741456c656d656e74313735014e44454741456c656d656e74333331014e44454741456c656d656e74333332014e44454741456c656d656e74333336014e44454741456c656d656e74333337014e44454741456c656d656e74333338014e44454741456c656d656e74333339014e44454741456c656d656e74333430014e44454741456c656d656e74333431014e44454741456c656d656e74333432014e44454741456c656d656e74333433014e44454741456c656d656e74333435014f44454741456c656d656e7431393834014f44454741456c656d656e7432313835014f44454741456c656d656e7432323431014f44454741456c656d656e7432323531014f44454741456c656d656e7432323536014f44454741456c656d656e7432323635014f44454741456c656d656e7432333334014f44454741456c656d656e7432333335014f44454741456c656d656e7432333336014f44454741456c656d656e7432333337014f44454741456c656d656e7432343030014f44454741456c656d656e7432343031014f44454741456c656d656e743234303401581cb788fbee71a32d2efc5ee7d151f3917d99160f78fb1e41a1bbf80d8fa1494c454146544f4b454e1a505aca47581cd030b626219d81673bd32932d2245e0c71ae5193281f971022b23a78a148436172646f67656f1904ec581cdb30c7905f598ed0154de14f970de0f61f0cb3943ed82c891968480aa144434c41501a000445c0581cea153b5d4864af15a1079a94a0e2486d6376fa28aafad272d15b243aa14a0014df105368617264731a006acfc0581cf43a62fdc3965df486de8a0d32fe800963589c41b38946602a0dc535a144414749581a00823080581cf5f8e854af532d828d00381df799ba6db22d825c9b140e1d5795cf85a14e0014df10447261676f6e476f6c641a545eee57581cf6ac48c64aa7af16434d9f84e014d11fba38525b436acc338ff20b0da1434d74630b581cfbae99b8679369079a7f6f0da14a2cf1c2d6bfd3afdf3a96a64ab67aa1490014df1047454e53581a00075818581cfd5a192b76cb73f004edde3993c31f8846845d858fa29a19b8a19869a14348594e1a00512570581cfed1c459a47cbff56bd7d29c2dde0de3e9bd15cee02b98622fce82f7a24d43617264616e6f436f707065721a05f5e1004d43617264616e6f53696c7665721a000f424082583901228938ca5b3f5c0ed1ddb1408f8ac86a8efed099bdf124f15cba2805cf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d91a002956ef021a00046fd1031a09042451a100d9010282825820ac44f0fbf784df0e261bcfdc77a722c00ee88938a38c0d68c2700822fdbbbdd558400d4e24cff1c6aa5095065a0eb2656aaf0587fdd1243fab4d42168647e0364a551f486a6995d573467a1f55f75683de8b89c220f2548acf2548e7b8bba08fb40c8258207cfc00ab4d76508db024d1ce09b118c6baa31856be439b1a29a352710d113a7c584056d6c32497939eee6eab40d57e9fcc0e2730ac628af1d3257ca6974ab068e5e689b7836bd44ed2bb6ae1cc15eed5a20e6d6e71d8da532a7fa0cfff6d41de1808f5f6",
      ),
    );

    const usersWalletOutput = usersWallet
      .body()
      .outputs()[2] as TransactionOutput;
    const userUtxo = TransactionUnspentOutput.fromCore([
      {
        index: 1,
        txId: TransactionId(
          "f0ec51fbcd22738f58803f855775e3544cbce8cfe9200e364290e20a544d96ad",
        ),
      },
      usersWalletOutput.toCore(),
    ]);

    const refTx = Transaction.fromCbor(
      TxCBOR(
        "84a30081825820c06db939721d1537a7cb126846ba2de765dcb293f2ed1f8a45ae69844c2911b9000182a3005839016bb14aa14473d5398e74057fcbee366f553167938d670bb993ce53423c65a71bf205c0a9f847cca9fad1d560ffb50505080de08064057c35011a0072b1e003d8185905e782025905e25905df0100003232323232323232323232222325333009333323232323232323232300100122223253330163370e900000089919198070028009bae301c0013014004153330163370e90010008991919806000919998040040008030029bac301c0013014004153330163370e90020008991919804000919998040040008030029bac301c0013014004153330163370e900300089919191919b8900333300c00148000894ccc070cccc02c02c0080240204cdc0000a400420026eb0c078004c078008dd6980e000980a0020a99980b19b87480200044c8c8c8c94ccc068cdc3a400400226464a66603866e1d2002301e3754660306034660306034010900124004266e240040144cdc40008029bad3020001301800214a0603000266028602c66028602c0089001240006eb4c070004c0500104c8c8c8c94ccc068cdc3a400400226464a66603866e1d2002301e3754660306034660306034010900024004266e240140044cdc40028009bad3020001301800214a0603000266028602c66028602c0089000240006eb4c070004c050010c05000cc0040048894ccc05800852809919299980a18018010a51133300500500100330190033017002300100122225333015003100213232333300600600133003002004003301800430160033001001222533301200214a226464a6660206006004266600a00a0020062940c05400cc04c008c0040048894ccc04000852809919299980719b8f00200314a2266600a00a00200660260066eb8c044008cc014c01c005200037586600a600e6600a600e0049000240206600a600e6600a600e00490002401c2930b19002199191919119299980719b87480000044c8c8c8c94ccc058c0600084c926300700315330134901334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016301600130160023014001300c002153300f4912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300c00130010012232533300d3370e9000000899192999809980a8010a4c2a66020921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c602600260160042a66601a66e1d20020011323253330133015002132498cc0180048c9263300600600115330104901334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758602600260160042a66601a66e1d20040011323253330133015002132498cc0180048c9263300600600115330104901334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758602600260160042a66601a66e1d200600113232323253330153017002132498cc0200048c9263300800800115330124901334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758602a002602a0046eb4c04c004c02c00854ccc034cdc3a401000226464a666026602a0042930a99808249334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a602600260160042a66601a66e1d200a0011323253330133015002149854cc0412401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a602600260160042a6601c9212b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300b0013001001222533300f00214984c8ccc010010c04800c008c004c04000800ccc0040052000222233330073370e0020060184666600a00a66e000112002300e001002002230063754002460086ea80055cd2b9c5573aaae7955cfaba157441825839016bb14aa14473d5398e74057fcbee366f553167938d670bb993ce53423c65a71bf205c0a9f847cca9fad1d560ffb50505080de08064057c351a1d571d97021a00039589a10081825820d6a1079f0b3149edc032cb7d55c8733689cd3b7227e6de23cde60e41e83716f95840db7ae55855623d3f9ea05c5c1dc61d33eb9c3123d6eb7bb5eef9d5ccf1e79abd870ec5e5de8082f4b26efc3c57da6c17236654295f6617765b7bd59931c72e0df5f6",
      ),
    );
    const refOutput = refTx.body().outputs()[0] as TransactionOutput;
    const refUtxo = TransactionUnspentOutput.fromCore([
      {
        index: 0,
        txId: TransactionId(
          "5af2bc2b1c983f65122d8737755d1de6e88c4d24797fdfac2c01e5156c15256f",
        ),
      },
      refOutput.toCore(),
    ]);

    const txBuilder = new TxBuilder(hardCodedProtocolParams);
    txBuilder.setNetworkId(NetworkId.Mainnet);

    const tx = txBuilder
      .useEvaluator(makeUplcEvaluator(hardCodedProtocolParams, 1, 1))
      .setChangeAddress(positionUtxo.output().address())
      .addRequiredSigner(
        Ed25519KeyHashHex(
          "c0cb190bf8f99d51bd6e08939256ff9b42becb7e3fe01cfa8eb4d4c1",
        ),
      )
      .addRequiredSigner(
        Ed25519KeyHashHex(
          "cf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d9",
        ),
      )
      .addUnspentOutputs([positionUtxo, userUtxo])
      .addReferenceInput(refUtxo)
      .addInput(positionUtxo, PlutusData.fromCbor(HexBlob("d87a80")));

    // Should throw an error that ther is not enough ADA to cover the minutxo value.
    expect(tx.complete()).rejects.toThrowErrorMatchingSnapshot();
  });

  it("should prepare collateral correctly when spending a script input", async () => {
    const usersPosition = Transaction.fromCbor(
      TxCBOR(
        "84a900838258206f2858e276b5acfb136f566947836b72cf3fac13f791e2b0009f62d485dcf63400825820a53d07bd90fefdab90e628da80fcf152e4370abfbaf65ce6f6f64a74c5bab32004825820a53d07bd90fefdab90e628da80fcf152e4370abfbaf65ce6f6f64a74c5bab320000183a30058391173275b9e267fd927bfc14cf653d904d1538ad8869260ab638bf73f5cd7244b4a8777b7dc6909f4640cf02ea4757a557a99fb483b05f87dfe01821a004c4b40a1581ce0302560ced2fdcbfcb2602697df970cd0d6a38f94b32703f51c312ba158200014df102f36866691fa75a9aab66dec99f7cc2d297ca09e34d9ce68cde047731a008f2fa3028201d8185853d8799fd8799f581ccf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d9ff9fd87a9f4653554e444145581c2f36866691fa75a9aab66dec99f7cc2d297ca09e34d9ce68cde047731864ffffff82583901a4365ab5a9b57fb90a1c616d64b467596d9291547c2418610e43776acf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d9821a00d96b9cb838581c016be5325fd988fea98ad422fcfd53e5352cacfced5c106a932a35a4a14342544e1a0003cd9e581c10a49b996e2402269af553a8a96fb8eb90d79e9eca79e2b4223057b6a1444745524f1a06c9f9e0581c13057a460cfd6c33952483d18f09d83a5eba3537ad4250a2c6587f0aa144424c55451a00017337581c160a880d9fc45380737cb7e57ff859763230aab28b3ef6a84007bfcca1444d495241192904581c16fdd33c86af604e837ae57d79d5f0f1156406086db5f16afb3fcf51a14544474f4c441a62590080581c1774343241680e4daef7cbfe3536fc857ce23fb66cd0b66320b2e3dda1454249534f4e1a01312cfe581c1a71dc14baa0b4fcfb34464adc6656d0e562571e2ac1bc990c9ce5f6a144574f4c461b00000002d1e0e3c4581c1d7f33bd23d85e1a25d87d86fac4f199c3197a2f7afeb662a0f34e1ea150776f726c646d6f62696c65746f6b656e1a000d6ed2581c1f4b1b277c9c001c1522727506a2cfb401a0d0ade069b0241f16f07da14248491a001e8480581c25c5de5f5b286073c593edfd77b48abc7a48e5a4f3d4cd9d428ff935a144444547411b000029baea2bb971581c279c909f348e533da5808898f87f9a14bb2c3dfbbacccd631d927a3fa144534e454b18a0581c29d222ce763455e3d7a09a665ce554f00ac89d2e99a1a83d267170c6a1434d494e1a0002fc0e581c2afb448ef716bfbed1dcb676102194c3009bee5399e93b90def9db6aa1454249534f4e1a00a7d8be581c2d7444cf9e317a12e3eb72bf424fd2a0c8fbafedf10e20bfdb4ad8aba1464348454444411a00061a7e581c3b31e746a68c5bef72c0fb9f2185e6b1fad0ea2faaccfeeb275afe91a14552454143481a0b626dc0581c3d77d63dfa6033be98021417e08e3368cc80e67f8d7afa196aaa0b39a14c53746172636820546f6b656e1a00027100581c420000029ad9527271b1b1e3c27ee065c18df70a4a4cfc3093a41a44a14341584f1a02a1c078581c42b39974c406678cfb65a16e0d7ac97d467b0db06ba669ad0942a9f9a145414d454c441a00013880581c438514ae1beb020d35e5389993447cea29637d6272c918017988ef36a1484164615969656c641b0000000165a0bc00581c4a043115b498be47874c6f5f2bd5056e5c7d81c93c6a4c603b526ccea145614d454c4401581c51a5e236c4de3af2b8020442e2a26f454fda3b04cb621c1294a0ef34a144424f4f4b1a00b5baf8581c547ceed647f57e64dc40a29b16be4f36b0d38b5aa3cd7afb286fc094a1476262486f736b791903e6581c577f0b1342f8f8f4aed3388b80a8535812950c7a892495c0ecdf0f1ea1480014df10464c44541844581c59515c449f1ec1d21a4b2d93013337d13b29d74c3a665a11d5b7fc66a14544534c56521b0000000df8475800581c5dac8536653edc12f6f5e1045d8164b9f59998d3bdc300fc92843489a1444e4d4b521b000000060c44a738581c5eee9c6e9cc2701d1af66b3370a108472f0e173e5e70c6c7a0af58f9a24b4372797374616c31303730014b4372797374616c3734303301581c641f0571d02b45b868ac1c479fc8118c5be6744ec3d2c5e13bd888b6a1465a4f4d424945190bb6581c682fe60c9918842b3323c43b5144bc3d52a23bd2fb81345560d73f63a1444e45574d1a02faf080581c6cc5da99ec107947f922e81038b2f5accba43b76d2b1f515673a8c24a24e437261796f6e4372657735343936014e437261796f6e437265773536323201581c6d06570ddd778ec7c0cca09d381eca194e90c8cffa7582879735dbdea1435845521b00000004ad0f58d5581c8434cc23a47cfa0d68d729b480169bfa3f910310a8184f43cfbcc02ca1470014df104c54591a000aaffa581c8483844875ce4d61c2aa459240f277d32081ee08fe0ad16899a0f581a1490014df10544954414e1b0000000110c7035c581c8d0ae3c5b13b47907b16511a540d47436d12dcc96453c0f59089b451a14542524f4f4d1a00497791581c8e1d94b7ac5db949a55720f054534b55b66f9a1f7d5a8a2132427369a14756643476674e4102581c96ad5ab136d2193dda2afb662285b93e48d265e14df59ee0f33925aea1444447454d1a01e0a6e0581c9cb29862cdce7cc8a5eff4b3634d3afa7c8241b04fc4839a372d448aa14953757065724475636b1a058675c8581ca1b253ba5fb215164ad2d729d91222a4dfd857c0b10c8f40c4d10b0ea145414d49524101581caf2e27f580f7f08e93190a81f72462f153026d06450924726645891ba144445249501a7d49264f581cafc910d7a306d20c12903979d4935ae4307241d03245743548e76783a14541534849421b000000030236127e581cb06729158210bf1ba13f8f3d7d422a918d3eaa82561a705552a2568ba1581a4d656c642042616e6b204d616e6167657220763120323233343801581cb2b2efec2dd5923e8e70bdc77cf40f41aafc6676cfa752f37f2ec6fbb81e4e44454741456c656d656e74313632014e44454741456c656d656e74313635014e44454741456c656d656e74313637014e44454741456c656d656e74313638014e44454741456c656d656e74313639014e44454741456c656d656e74313735014e44454741456c656d656e74333331014e44454741456c656d656e74333332014e44454741456c656d656e74333336014e44454741456c656d656e74333337014e44454741456c656d656e74333338014e44454741456c656d656e74333339014e44454741456c656d656e74333430014e44454741456c656d656e74333431014e44454741456c656d656e74333432014e44454741456c656d656e74333433014e44454741456c656d656e74333435014f44454741456c656d656e7431393834014f44454741456c656d656e7432313835014f44454741456c656d656e7432323431014f44454741456c656d656e7432323531014f44454741456c656d656e7432323536014f44454741456c656d656e7432323635014f44454741456c656d656e7432333334014f44454741456c656d656e7432333335014f44454741456c656d656e7432333336014f44454741456c656d656e7432333337014f44454741456c656d656e7432343030014f44454741456c656d656e7432343031014f44454741456c656d656e743234303401581cb6a7467ea1deb012808ef4e87b5ff371e85f7142d7b356a40d9b42a0a1581e436f726e75636f70696173205b76696120436861696e506f72742e696f5d1a442fc95c581cb788fbee71a32d2efc5ee7d151f3917d99160f78fb1e41a1bbf80d8fa1494c454146544f4b454e1a505aca47581cc881c20e49dbaca3ff6cef365969354150983230c39520b917f5cf7ca1444e696b65190e0d581cd030b626219d81673bd32932d2245e0c71ae5193281f971022b23a78a148436172646f67656f1904ec581cdb30c7905f598ed0154de14f970de0f61f0cb3943ed82c891968480aa144434c41501a000445c0581ce1cc6498cdaa972c3dc7b374b6b7cc5e05fb0fe4955a4dd380e4ff0da3582037d16d718e3d53e454a8dd49f32bb0a719647e63bbc65425b3f90c1a298f96aa01582081703303aa3348403e2ceaba4c4fa6c763df5473556905608d3339b3216f11860158209d029762f1ce804c7338757b046d5542f4f1bb83cdca238cf06acdeacd9e98ec01581cea153b5d4864af15a1079a94a0e2486d6376fa28aafad272d15b243aa14a0014df105368617264731a006acfc0581cecd0970cb2d599a8bdb61f6eb597e25eaf34d76bdf8ade17b6a8fa59a14a000de14053483031373901581cf0ff48bbb7bbe9d59a40f1ce90e9e9d0ff5002ec48f232b49ca0fb9aa14e000de140626c61636b776f6c667801581cf43a62fdc3965df486de8a0d32fe800963589c41b38946602a0dc535a144414749581a00823080581cf5f8e854af532d828d00381df799ba6db22d825c9b140e1d5795cf85a14e0014df10447261676f6e476f6c641a545eee57581cf6ac48c64aa7af16434d9f84e014d11fba38525b436acc338ff20b0da1434d74630b581cfbae99b8679369079a7f6f0da14a2cf1c2d6bfd3afdf3a96a64ab67aa1490014df1047454e53581a00075818581cfd5a192b76cb73f004edde3993c31f8846845d858fa29a19b8a19869a14348594e1a00512570581cfed1c459a47cbff56bd7d29c2dde0de3e9bd15cee02b98622fce82f7a24d43617264616e6f436f707065721a05f5e1004d43617264616e6f53696c7665721a000f424082583901a4365ab5a9b57fb90a1c616d64b467596d9291547c2418610e43776acf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d91a0044aa20021a0007a1200b5820dd766a5bb9deba9c3a776817207d81d6515ccdf3e5e4347ea4a2847129efb0400d81825820a53d07bd90fefdab90e628da80fcf152e4370abfbaf65ce6f6f64a74c5bab320000e82581cc0cb190bf8f99d51bd6e08939256ff9b42becb7e3fe01cfa8eb4d4c1581ccf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d91082583901a4365ab5a9b57fb90a1c616d64b467596d9291547c2418610e43776acf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d91a0040d990111a000b71b012818258205af2bc2b1c983f65122d8737755d1de6e88c4d24797fdfac2c01e5156c15256f00a200838258205b19736e711641445a7c6655da989ae04cd3f2408668eb308ad81eda8a830f4f584018f4e84257eb54b32692012854f95fb2df0b24b7649ad0e8fe2061ffa75a58d7ad7581f6f2eadaa656d40f449ac1c20db9e9760f08a0c678ad4b560707e8d70982582049e361ffcdfcb4e9e54d26fcde6c874c1e9231692b89c92190bdd227fe588d4258401c532a55b3c383872dc747cf106760464df1d1e802a021de1bea5daa58d13b80b289e66f47b7a53799fb2614546ab749b0b7524b57396d661ec8604a1ea202008258202056c5bbb7e3d18e7592dc6e42b9c4b0ac415a6898b34ccbca75776bc6ae4d3a5840a215d878fc464be6c84c13d0e1f76b451a5eb8709893d65e4d3bdf31d675a6e04f49c317541f8452e82f352bd9a935aa504318982e18a64eeeeb6e39d4b5c90e0581840000d87a80821a000182311a018144a1f5f6",
      ),
    );

    const usersPositionOutput = usersPosition
      .body()
      .outputs()[0] as TransactionOutput;

    const positionUtxo = TransactionUnspentOutput.fromCore([
      {
        index: 0,
        txId: TransactionId(
          "f1eeae5d97d171913296117859ab801657a96321245c84ff4a4f33ebd4217508",
        ),
      },
      usersPositionOutput.toCore(),
    ]);

    const usersWallet = Transaction.fromCbor(
      TxCBOR(
        "84a400d90102828258208286e6132af7019ea6232417affbc4256ceea1c6ca5be80355a468793a0eda6600825820c97be6f9fa702f69afa829ebbc98c2b557c97ecacb40a65cd2d66ed5c79776c601018482581d61c0cb190bf8f99d51bd6e08939256ff9b42becb7e3fe01cfa8eb4d4c11a004c4b4082583901228938ca5b3f5c0ed1ddb1408f8ac86a8efed099bdf124f15cba2805cf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d91a001e848082583901228938ca5b3f5c0ed1ddb1408f8ac86a8efed099bdf124f15cba2805cf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d9821a00b5b5b2b82e581c016be5325fd988fea98ad422fcfd53e5352cacfced5c106a932a35a4a14342544e1a0003cd9e581c10a49b996e2402269af553a8a96fb8eb90d79e9eca79e2b4223057b6a1444745524f1a06c9f9e0581c13057a460cfd6c33952483d18f09d83a5eba3537ad4250a2c6587f0aa144424c55451a00017337581c160a880d9fc45380737cb7e57ff859763230aab28b3ef6a84007bfcca1444d495241192904581c16fdd33c86af604e837ae57d79d5f0f1156406086db5f16afb3fcf51a14544474f4c441a62590080581c1774343241680e4daef7cbfe3536fc857ce23fb66cd0b66320b2e3dda1454249534f4e1a01312cfe581c1a71dc14baa0b4fcfb34464adc6656d0e562571e2ac1bc990c9ce5f6a144574f4c461b00000002d1e0e3c4581c1d7f33bd23d85e1a25d87d86fac4f199c3197a2f7afeb662a0f34e1ea150776f726c646d6f62696c65746f6b656e1a000d6ed2581c1f4b1b277c9c001c1522727506a2cfb401a0d0ade069b0241f16f07da14248491a001e8480581c279c909f348e533da5808898f87f9a14bb2c3dfbbacccd631d927a3fa144534e454b18a0581c29d222ce763455e3d7a09a665ce554f00ac89d2e99a1a83d267170c6a1434d494e1a0002fc0e581c2afb448ef716bfbed1dcb676102194c3009bee5399e93b90def9db6aa1454249534f4e1a00a7d8be581c2d7444cf9e317a12e3eb72bf424fd2a0c8fbafedf10e20bfdb4ad8aba1464348454444411a00061a7e581c3b31e746a68c5bef72c0fb9f2185e6b1fad0ea2faaccfeeb275afe91a14552454143481a0b626dc0581c3d77d63dfa6033be98021417e08e3368cc80e67f8d7afa196aaa0b39a14c53746172636820546f6b656e1a00027100581c420000029ad9527271b1b1e3c27ee065c18df70a4a4cfc3093a41a44a14341584f1a02a1c078581c438514ae1beb020d35e5389993447cea29637d6272c918017988ef36a1484164615969656c641b0000000165a0bc00581c51a5e236c4de3af2b8020442e2a26f454fda3b04cb621c1294a0ef34a144424f4f4b1a00b5baf8581c547ceed647f57e64dc40a29b16be4f36b0d38b5aa3cd7afb286fc094a1476262486f736b791903e6581c577f0b1342f8f8f4aed3388b80a8535812950c7a892495c0ecdf0f1ea1480014df10464c44541844581c59515c449f1ec1d21a4b2d93013337d13b29d74c3a665a11d5b7fc66a14544534c56521b0000000df8475800581c5eee9c6e9cc2701d1af66b3370a108472f0e173e5e70c6c7a0af58f9a24b4372797374616c31303730014b4372797374616c3734303301581c641f0571d02b45b868ac1c479fc8118c5be6744ec3d2c5e13bd888b6a1465a4f4d424945190bb6581c682fe60c9918842b3323c43b5144bc3d52a23bd2fb81345560d73f63a1444e45574d1a02faf080581c6cc5da99ec107947f922e81038b2f5accba43b76d2b1f515673a8c24a24e437261796f6e4372657735343936014e437261796f6e437265773536323201581c8434cc23a47cfa0d68d729b480169bfa3f910310a8184f43cfbcc02ca1470014df104c54591a000aaffa581c8483844875ce4d61c2aa459240f277d32081ee08fe0ad16899a0f581a1490014df10544954414e1b0000000110c7035c581c8d0ae3c5b13b47907b16511a540d47436d12dcc96453c0f59089b451a14542524f4f4d1a00497791581c8e1d94b7ac5db949a55720f054534b55b66f9a1f7d5a8a2132427369a14756643476674e4102581c96ad5ab136d2193dda2afb662285b93e48d265e14df59ee0f33925aea1444447454d1a01e0a6e0581c9cb29862cdce7cc8a5eff4b3634d3afa7c8241b04fc4839a372d448aa14953757065724475636b1a058675c8581ca0028f350aaabe0545fdcb56b039bfb08e4bb4d8c4d7c3c7d481c235a145484f534b591a0605887d581caf2e27f580f7f08e93190a81f72462f153026d06450924726645891ba144445249501a7d49264f581cafc910d7a306d20c12903979d4935ae4307241d03245743548e76783a14541534849421b000000030236127e581cb06729158210bf1ba13f8f3d7d422a918d3eaa82561a705552a2568ba1581a4d656c642042616e6b204d616e6167657220763120323233343801581cb2b2efec2dd5923e8e70bdc77cf40f41aafc6676cfa752f37f2ec6fbb81e4e44454741456c656d656e74313632014e44454741456c656d656e74313635014e44454741456c656d656e74313637014e44454741456c656d656e74313638014e44454741456c656d656e74313639014e44454741456c656d656e74313735014e44454741456c656d656e74333331014e44454741456c656d656e74333332014e44454741456c656d656e74333336014e44454741456c656d656e74333337014e44454741456c656d656e74333338014e44454741456c656d656e74333339014e44454741456c656d656e74333430014e44454741456c656d656e74333431014e44454741456c656d656e74333432014e44454741456c656d656e74333433014e44454741456c656d656e74333435014f44454741456c656d656e7431393834014f44454741456c656d656e7432313835014f44454741456c656d656e7432323431014f44454741456c656d656e7432323531014f44454741456c656d656e7432323536014f44454741456c656d656e7432323635014f44454741456c656d656e7432333334014f44454741456c656d656e7432333335014f44454741456c656d656e7432333336014f44454741456c656d656e7432333337014f44454741456c656d656e7432343030014f44454741456c656d656e7432343031014f44454741456c656d656e743234303401581cb788fbee71a32d2efc5ee7d151f3917d99160f78fb1e41a1bbf80d8fa1494c454146544f4b454e1a505aca47581cd030b626219d81673bd32932d2245e0c71ae5193281f971022b23a78a148436172646f67656f1904ec581cdb30c7905f598ed0154de14f970de0f61f0cb3943ed82c891968480aa144434c41501a000445c0581cea153b5d4864af15a1079a94a0e2486d6376fa28aafad272d15b243aa14a0014df105368617264731a006acfc0581cf43a62fdc3965df486de8a0d32fe800963589c41b38946602a0dc535a144414749581a00823080581cf5f8e854af532d828d00381df799ba6db22d825c9b140e1d5795cf85a14e0014df10447261676f6e476f6c641a545eee57581cf6ac48c64aa7af16434d9f84e014d11fba38525b436acc338ff20b0da1434d74630b581cfbae99b8679369079a7f6f0da14a2cf1c2d6bfd3afdf3a96a64ab67aa1490014df1047454e53581a00075818581cfd5a192b76cb73f004edde3993c31f8846845d858fa29a19b8a19869a14348594e1a00512570581cfed1c459a47cbff56bd7d29c2dde0de3e9bd15cee02b98622fce82f7a24d43617264616e6f436f707065721a05f5e1004d43617264616e6f53696c7665721a000f424082583901228938ca5b3f5c0ed1ddb1408f8ac86a8efed099bdf124f15cba2805cf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d91a002956ef021a00046fd1031a09042451a100d9010282825820ac44f0fbf784df0e261bcfdc77a722c00ee88938a38c0d68c2700822fdbbbdd558400d4e24cff1c6aa5095065a0eb2656aaf0587fdd1243fab4d42168647e0364a551f486a6995d573467a1f55f75683de8b89c220f2548acf2548e7b8bba08fb40c8258207cfc00ab4d76508db024d1ce09b118c6baa31856be439b1a29a352710d113a7c584056d6c32497939eee6eab40d57e9fcc0e2730ac628af1d3257ca6974ab068e5e689b7836bd44ed2bb6ae1cc15eed5a20e6d6e71d8da532a7fa0cfff6d41de1808f5f6",
      ),
    );

    const usersWalletOutput = usersWallet
      .body()
      .outputs()[2] as TransactionOutput;

    const refTx = Transaction.fromCbor(
      TxCBOR(
        "84a30081825820c06db939721d1537a7cb126846ba2de765dcb293f2ed1f8a45ae69844c2911b9000182a3005839016bb14aa14473d5398e74057fcbee366f553167938d670bb993ce53423c65a71bf205c0a9f847cca9fad1d560ffb50505080de08064057c35011a0072b1e003d8185905e782025905e25905df0100003232323232323232323232222325333009333323232323232323232300100122223253330163370e900000089919198070028009bae301c0013014004153330163370e90010008991919806000919998040040008030029bac301c0013014004153330163370e90020008991919804000919998040040008030029bac301c0013014004153330163370e900300089919191919b8900333300c00148000894ccc070cccc02c02c0080240204cdc0000a400420026eb0c078004c078008dd6980e000980a0020a99980b19b87480200044c8c8c8c94ccc068cdc3a400400226464a66603866e1d2002301e3754660306034660306034010900124004266e240040144cdc40008029bad3020001301800214a0603000266028602c66028602c0089001240006eb4c070004c0500104c8c8c8c94ccc068cdc3a400400226464a66603866e1d2002301e3754660306034660306034010900024004266e240140044cdc40028009bad3020001301800214a0603000266028602c66028602c0089000240006eb4c070004c050010c05000cc0040048894ccc05800852809919299980a18018010a51133300500500100330190033017002300100122225333015003100213232333300600600133003002004003301800430160033001001222533301200214a226464a6660206006004266600a00a0020062940c05400cc04c008c0040048894ccc04000852809919299980719b8f00200314a2266600a00a00200660260066eb8c044008cc014c01c005200037586600a600e6600a600e0049000240206600a600e6600a600e00490002401c2930b19002199191919119299980719b87480000044c8c8c8c94ccc058c0600084c926300700315330134901334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016301600130160023014001300c002153300f4912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300c00130010012232533300d3370e9000000899192999809980a8010a4c2a66020921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c602600260160042a66601a66e1d20020011323253330133015002132498cc0180048c9263300600600115330104901334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758602600260160042a66601a66e1d20040011323253330133015002132498cc0180048c9263300600600115330104901334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758602600260160042a66601a66e1d200600113232323253330153017002132498cc0200048c9263300800800115330124901334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758602a002602a0046eb4c04c004c02c00854ccc034cdc3a401000226464a666026602a0042930a99808249334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a602600260160042a66601a66e1d200a0011323253330133015002149854cc0412401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a602600260160042a6601c9212b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300b0013001001222533300f00214984c8ccc010010c04800c008c004c04000800ccc0040052000222233330073370e0020060184666600a00a66e000112002300e001002002230063754002460086ea80055cd2b9c5573aaae7955cfaba157441825839016bb14aa14473d5398e74057fcbee366f553167938d670bb993ce53423c65a71bf205c0a9f847cca9fad1d560ffb50505080de08064057c351a1d571d97021a00039589a10081825820d6a1079f0b3149edc032cb7d55c8733689cd3b7227e6de23cde60e41e83716f95840db7ae55855623d3f9ea05c5c1dc61d33eb9c3123d6eb7bb5eef9d5ccf1e79abd870ec5e5de8082f4b26efc3c57da6c17236654295f6617765b7bd59931c72e0df5f6",
      ),
    );
    const refOutput = refTx.body().outputs()[0] as TransactionOutput;
    const refUtxo = TransactionUnspentOutput.fromCore([
      {
        index: 0,
        txId: TransactionId(
          "5af2bc2b1c983f65122d8737755d1de6e88c4d24797fdfac2c01e5156c15256f",
        ),
      },
      refOutput.toCore(),
    ]);

    const collateralUtxo = TransactionUnspentOutput.fromCore([
      {
        index: 0,
        txId: TransactionId("0".repeat(64)),
      },
      {
        address: PaymentAddress(usersWalletOutput.address().toBech32()),
        value: makeValue(5_000_000n).toCore(),
      },
    ]);

    // Add a nice collateral UTXO.
    const tx = await new TxBuilder(hardCodedProtocolParams)
      .setNetworkId(NetworkId.Mainnet)
      .useEvaluator(makeUplcEvaluator(hardCodedProtocolParams, 1, 1))
      .setChangeAddress(positionUtxo.output().address())
      .addRequiredSigner(
        Ed25519KeyHashHex(
          "c0cb190bf8f99d51bd6e08939256ff9b42becb7e3fe01cfa8eb4d4c1",
        ),
      )
      .addRequiredSigner(
        Ed25519KeyHashHex(
          "cf2eac496d909a41916f955f1ab064e00edb8cbe12f5817ec89db7d9",
        ),
      )
      .addUnspentOutputs([positionUtxo, collateralUtxo])
      .addReferenceInput(refUtxo)
      .addInput(positionUtxo, PlutusData.fromCbor(HexBlob("d87a80")))
      .complete();

    expect(tx.body().collateral()?.size()).toEqual(1);
    const collateralInput = tx
      .body()
      .collateral()!
      .values()[0] as TransactionInput;

    expect(isEqualInput(collateralInput, collateralUtxo.input())).toBeTruthy();

    const collateralOutput = tx.body().collateralReturn();

    const totalCollateral = tx.body().totalCollateral() || 0n;
    const diff = collateralUtxo.output().amount().coin() - totalCollateral;

    expect(diff.toString()).toEqual(
      collateralOutput?.amount().coin().toString(),
    );
  });
});
