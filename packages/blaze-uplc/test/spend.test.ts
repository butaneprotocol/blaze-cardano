import {
  HexBlob,
  PlutusData,
  PlutusList,
  fromHex,
  toHex,
} from "@blaze-cardano/core";
import { applyParams } from "../src/index";
import { apply_params_to_script } from "uplc-node";
import { UPLCDecoder } from "../src/decoder";
import { UPLCEncoder } from "../src/encoder";

describe("Script Deserialisation", () => {
  it("Should be able to parse the spec example", () => {
    const spend = "0500023371C911071A5F783625EE8C004838B40181".toLowerCase();
    const AST = UPLCDecoder.decodeFromHex(spend);
    expect(AST).toBeTruthy();
  });

  it("Should be able to parse the spec example", () => {
    const spend = "010000480081".toLowerCase();
    const AST = UPLCDecoder.decodeFromHex(spend);
    expect(AST).toBeTruthy();
  });

  it("Should be able to parse the optimised spend validator", () => {
    const spend =
      "01000032323232322222323330010010053756601260146014601460146014601460106EA8C024C020DD5001111299980419BAF3009300B00100214984CCC00C00C008C0300055CD2AB9D5573CAE855D11".toLowerCase();
    const AST = UPLCDecoder.decodeFromHex(spend);
    expect(AST).toBeTruthy();
  });

  it("Should be able to parse a v3 script", () => {
    const helloWorld =
      "0101003232323232323225333002323232323253330073370e900118041baa0011323232533300a3370e900018059baa005132533300e0011613253333330120011616161613253330103012003132533300e3370e900018079baa005132533300f002100114a06644646600200200644a66602a00229404c94ccc04ccdc79bae301700200414a2266006006002602e0026eb0c048c04cc04cc04cc04cc04cc04cc04cc04cc040dd50059bae301230103754602460206ea801458cdc79bae3011300f375401091010d48656c6c6f2c20576f726c64210016375c002601e00260186ea801458c034c038008c030004c024dd50008b1805180580118048009804801180380098021baa00114984d9595cd2ab9d5573caae7d5d0aba25749";
    const AST = UPLCDecoder.decodeFromHex(helloWorld);
    expect(AST).toBeTruthy();
    expect(AST.version).toBe("1.1.0");
  });
});

const roundTrips = [
  "010000480081",
  "0500023371C911071A5F783625EE8C004838B40181",
  "01000032323232322222323330010010053756601260146014601460146014601460106EA8C024C020DD5001111299980419BAF3009300B00100214984CCC00C00C008C0300055CD2AB9D5573CAE855D11",
  "010000333232323232323222322253330063232323232323253233300E3370E90020028992999807980118081BAA0011325333010300630113754002264646464A66602E6034004264646600200200A44A66603400229404C94CCC060CDD7802180C980E8010A51133003003001301D0013374A90001980C19BA548008CC060C0540052F5C097AE0163018001330073756646002602A6EA8C004C054DD519198008009BAC301900422323253330173375E601660326EA800804C40084CC010010004C070008C0680048C060C064004DD7180B980A1BAA0033756602C602E602E602E602E602E002602C60246EA802458C050C044DD50008B180998081BAA0061533300E300100513232323232325323330153008301637540222A66602A646600200200C44A66603400229404C94CCC060CDD79806180D1BAA301D00201714A2266006006002603A00226464A666034603A004264A666030601C6EB4C0680084C010DC68008A50375C60300022C603600266014600400800E2C264646464A666038603E004264646464A66603AA66603A60260062A66603A66E1C005200113009371A00829405280A511533301D3370E00690008A99980E9809800898049B8D00214A02940DD6980F0021BAE301C003375A60380086EB8C06800C58C074004C074008C06C004CC028C00801001CDC3A40704646600200200444A666032002297ADEF6C60132323232533301A33722911000021533301A3371E9101000021003100513301E337606EA4008DD3000998030030019BAB301B003375C6032004603A004603600264A666026600C0022A66602C602A6EA803C52616153330133009001153330163015375401E2930B0B18099BAA00E3756602C602E602E602E602E0046EB0C054004C044DD50041BAE30133010375400C2940DC3A4000460240024464A66601C6008601E6EA800452F5BDED8C026EACC04CC040DD500099198008008019129998090008A6103D87A800013232323253330133372200E0042A66602666E3C01C0084CDD2A40006602E6E980052F5C02980103D87A8000133006006003375660280066EB8C048008C058008C050004DC3A400460146EA8004C034C038008C030004C020DD50008A4C26CAC6EB40055CD2AB9D5573CAAE7D5D02BA1574498012BD8799FD8799F58200000000000000000000000000000000000000000000000000000000000000000FF00FF004C0101000001",
  "010100229800aba2aba1aab9faab9eaab9dab9a48888896600264653001300700198039804000cc01c0092225980099b8748008c01cdd500144ca60026016003300b300c00198041baa0048a51488896600266e1d20000028acc004c034dd500440062c80722b30013370e90010014566002601a6ea802200316403915980099b874801000a2b3001300d37540110018b201c8acc004cdc3a400c00515980098069baa008800c5900e456600266e1d20080028acc004c034dd500440062c80722c805900b2016402c805860106ea800a29410060c01c004c00cdd5003c52689b2b200201",
];

describe("Decode . Encode = Identity", () => {
  it("Should be able to decode and invert the roundtrip example", () => {
    for (const rtExample of roundTrips) {
      const AST = UPLCDecoder.decodeFromHex(rtExample);
      const reencoded = new UPLCEncoder().encodeProgram(AST);
      expect(toHex(reencoded).toUpperCase()).toBe(rtExample.toUpperCase());
      expect(toHex(reencoded).length).toBe(rtExample.length);
    }
  });
});

describe("Apply params", () => {
  it("Should be able to apply parameters to a script", () => {
    const script = HexBlob(
      "5866010000323232323232223222533300632330010013756601660186018601860186018601860126ea8c02cc024dd50011129998058008a5013253330093375e0106014601a00429444cc00c00c004c03400452613656375a002ae6955ceaab9e5573eae855d11",
    );
    const params = [
      PlutusData.newBytes(fromHex("abcdef")),
      PlutusData.newInteger(BigInt(123)),
    ];
    const paramsList = new PlutusList();
    params.forEach((x) => paramsList.add(x));
    const aikenApply = apply_params_to_script(
      fromHex(paramsList.toCbor()),
      fromHex(script),
    );
    const blazeApply = applyParams(script, ...params);
    expect(toHex(aikenApply).toUpperCase()).toBe(blazeApply.toUpperCase());
  });
});
